<!DOCTYPE html>
<html>
<head>
	<title>Network</title>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta charset="utf-8">
	<script src="/static/js/jquery.min.js"></script>
	<script src="/static/js/d3.v7.min.js"></script>
	<link rel="stylesheet" href="/static/css/bulma.min.css">
	<link rel="stylesheet" href="/static/css/fa-all.min.css">
	<link rel="icon" type="image/png" href="/static/img/its_logo.png">
	<style type="text/css">
		/* Bulma Overrides for theming */
		:root {
			--base-color: {base_color};
			--base-color_rgb: {base_color_r}, {base_color_g}, {base_color_b};
			--middle-color: rgba(var(--base-color_rgb), 0.25);
			--lighter-color: rgba(var(--base-color_rgb), 0.1);
		}
		a { color: var(--base-color); }
		.navbar.is-info { background: var(--base-color); }
		.button.is-info.is-light { color: var(--base-color); background: var(--lighter-color); }
		section tbody.info-table tr { background-color: var(--middle-color); }
		section .message.is-info,
		section tbody.info-table tr:nth-child(2n) { background-color: var(--lighter-color); }
		section .message.is-info .message-body { border-color: var(--base-color); }

		/* Custom Rules for the layout */
		#networkarea,
		#networklist {
			position: fixed;
			border: 1px solid lightgray;
			top: 60px;
			left: 0;
			right: 33.3333333%;
			bottom: 41px;
		}
		#networklist { padding: 10px 10px 40px; overflow: scroll; }
		#networklist table { width: 100%; }
		#networklist table tbody tr { cursor: pointer; }

		footer.footer {
			position: fixed;
			bottom: 0;
			height: 35px;
			width: 100vw;
			font-size: 0.8em;
			overflow: hidden;
		}
		footer.footer small {
			font-size: 0.8em;
		}

		#scan-now-modal .modal-card-body {
			color: black;
		}
		#host-info-box {
			margin-bottom: 0.75rem;
		}
		#modal-hosts-history .modal-card { width: 80vw; }
		#config .input.full-width { width: 18rem; }
		#config .input.double-big { width: 13rem; }
		#config .input.double-small { width: 5rem; }
		.mouse-pointer {
			cursor: pointer;
		}
		#config-container,
		#scans-list,
		#networks-list,
		#windows-information {
			max-height: 80vh;
			overflow-y: scroll;
			min-height: 2.75em;
		}
		#config-container .navbar-item div.box {
			width: 100%;
		}

		.search {
			position: fixed;
			z-index: 20;
			top: 60px;
			right: 33.333333%;
			padding: 0.6rem;
		}
		.area-hint {
			width: 50%;
			position: fixed;
			bottom: 50px;
			left: 33.333333%;
			margin-left: -25%;
			text-align: center;
		}
		.view-modes {
			position: fixed;
			z-index: 1;
			bottom: 50px;
			right: 33.333333%;
			margin-right: 5px;
		}
		.view-menu-item img {
			vertical-align: middle;
		}

		.legend {
			position: fixed;
			z-index: 2;
			top: 60px;
			left: 0px;
			border: 1px solid lightgray;
			background: white;
			padding: 0.6rem;
			padding-bottom: 0;
			font-size: 0.75rem;
		}
		.legend .columns {
			margin-bottom: 0 !important;
		}
		.legend .column {
			padding: 0.6rem;
		}
		.legend .legend-text {
			white-space: nowrap;
			width: 6vw;
		}
		.legend .legend-entry {
			border: 1px solid #2B7CE9;
			border-radius: 50%;
			width: 16px;
			height: 16px;
		}
		.legend .legend-image {
			border: none;
		}
		.scan-info {
			margin: 1rem 0;
		}

		tbody.info-table th {
			text-transform: capitalize;
		}
		tbody.info-table tr {
			background-color: #d7e6f5;
		}
		tbody.info-table tr:nth-child(2n) {
			background-color: #eff5fb;
		}

		svg .hidden {
			display: none;
		}
		svg .selected {
			stroke: #14990D !important;
		}
		svg .fixed {
			stroke: #990C39;
		}
		#legend-color-windows,
		svg image.netbios {
			filter: invert(.5) sepia(1) saturate(4) hue-rotate(180deg);
		}
		#legend-color-vulnerable,
		svg image.vulnerable {
			filter: invert(.4) sepia(1) saturate(4) hue-rotate(-30deg);
		}
		svg .node-label tspan {
			fill-opacity: 0.4;
		}
		svg .node-label tspan:first-child {
			fill-opacity: 1;
			font-weight: bold;
		}

		#modal-nse-scripts .modal-card {
			width: calc(100vw - 80px);
		}
		.scripts-list { padding-bottom: 20px; }
		.scripts-list li { padding: 3px 0; }
		.script-name { text-decoration: underline; }
		.message-body code.script {
			background: none;: 3px 0;
			white-space: pre-line;
			padding: 0;
		}
	</style>
	</style>
</head>
<body>
	<section class="section pb-3">
		<nav class="navbar is-info is-fixed-top" role="navigation" aria-label="dropdown navigation">
			<div class="navbar-menu">
				<div class="navbar-brand">
					<span class="navbar-item"><img src="{logo}" alt="{tagline} Logo" height="12" /></span>
					<h1 class="navbar-item title is-4" style="vertical-align:baseline;">{tagline}&nbsp;<small style="font-weight:normal;font-size:0.65em;">({version})</small></h1>
				</div>

				<div class="navbar-start">
					<div class="navbar-item"><span class="tag is-warning" id="running-status">waiting</span></div>
					<div class="navbar-item"><span class="tag is-success" id="release-version">Up to date</span></div>
				</div>

				<div class="navbar-end">

					<a id="btn-osconfig" class="navbar-item">System</a>

					<div class="navbar-item has-dropdown has-dropdown is-hoverable">
						<span class="navbar-link">Config</span>
						<fieldset class="navbar-dropdown is-right" id="config">
							<div id="config-container">

								<div class="navbar-item">
									<div class="box">
										<p class="subtitle is-6">Global</p>
										<div class="field">
											<label class="label is-small">Scan time <small>(<a href="https://cron.help/" target="_blank">Cron-Syntax</a>)</small></label>
											<input class="input is-small full-width" placeholder="min  hour  dom  month  dow" type="text" name="repeat" value="" />
										</div>
										<div class="field">
											<label class="label is-small">Parallel asset scans</label>
											<input class="input is-small full-width" placeholder="10" type="number" name="threads" value="" />
										</div>
										<div class="field">
											<label class="label is-small">Scan-Scripts</label>
											<a id="btn-nse" class="button is-info is-light is-fullwidth is-small">Manage Scan-Scripts</a>
										</div>
										<div class="field">
											<label class="label is-small">Scan-Scripts Arguments</label>
											<input class="input is-small full-width" placeholder="" type="text" name="script-arguments" value="" />
											<p class="help">These arguments are passed to nmap via<br/><code>--script-args=VALUE</code></p>
										</div>
									</div>
								</div>

								<div class="navbar-item">
									<div class="box" id="config-network">
										<p class="subtitle is-6">Networks <small>(<a href="#" id="add-network-config">add</a>)</small></p>

										<div class="block tabs">
											<ul></ul>
										</div>

									</div>
								</div>

								<div class="navbar-item">
									<div class="box">
										<p class="subtitle is-6">White-Labeling <small>(<a href="#" id="clear-white-label">clear</a>)</small></p>
										<div class="field">
											<label class="label is-small">Logo</label>
											<div id="file-js-logo" class="file has-name is-small">
												<label class="file-label">
													<input class="file-input" type="file" name="logo" accept="image/png, image/jpeg, image/gif, image/svg+xml" />
													<span class="file-cta">
														<span class="file-icon"><i class="fas fa-upload"></i></span>
														<span class="file-label">Choose a file...</span>
													</span>
													<span class="file-name">No file uploaded</span>
												</label>
											</div>
										</div>
										<div class="field">
											<label class="label is-small">Tagline/Slogan</label>
											<input class="input is-small full-width" placeholder="NetworkDiscover" type="text" name="tagline" value="" />
										</div>
										<div class="field">
											<label class="label is-small">Color</label>
											<input class="input is-small full-width" type="color" name="color" value="" />
										</div>
										<div class="field">
											<label class="label is-small">Update Check URL</label>
											<input class="input is-small full-width" placeholder="https://api.github.com/repos/ITSGmbH/NetworkDiscover/releases/latest" type="text" name="update_check" value="" />
										</div>
									</div>
								</div>

								<div class="navbar-item">
									<div class="box">
										<p class="subtitle is-6">System Configuration</p>
										<div class="field">
											<label class="label is-small">Web-Listener</label>
											<input class="input is-small double-big" type="text" placeholder="0.0.0.0" name="listen-ip" value="" />
											<input class="input is-small double-small" type="number" placeholder="9090" name="listen-port" value="" />
										</div>
										<div class="field">
											<label class="label is-small">Database-Path</label>
											<input class="input is-small full-width" placeholder="" type="text" name="db-path" value="" />
										</div>
										<div class="field">
											<label class="label is-small">Database-URL</label>
											<input class="input is-small full-width" placeholder="" type="text" name="db-url" value="" />
										</div>
										<div class="field">
											<label class="label is-small">Network Device for scanning</label>
											<input class="input is-small full-width" placeholder="None" type="text" name="interface" value="" />
										</div>
									</div>
								</div>

							</div>
							<div class="navbar-item">
								<button class="button is-primary" id="config-save">Save</button>
							</div>
						</fieldset>
					</div>

					<div class="navbar-item has-dropdown has-dropdown is-hoverable">
						<span class="navbar-link">Networks</span>
						<div class="navbar-dropdown is-right" id="networks">
							<div class="navbar-item field"><p class="control has-icons-left"><input id="networks-search" type="text" class="input is-info is-small" placeholder="Search..." /><span class="icon is-small is-left"><i class="fas fa-search"></i></span></p></div>
							<div id="networks-list"></div>
						</div>
					</div>

					<div class="navbar-item has-dropdown has-dropdown is-hoverable">
						<span class="navbar-link">Scans</span>
						<div class="navbar-dropdown is-right" id="scans">
							<a class="navbar-item" id="scan-now">Scan now</a>
							<div class="navbar-item field m-0"><p class="control has-icons-left"><input id="scans-search" type="text" class="input is-info is-small" placeholder="Search..." /><span class="icon is-small is-left"><i class="fas fa-search"></i></span></p></div>
							<div class="navbar-item field m-0">
								<label class="checkbox"><input type="checkbox" id="scans-changed-only" /> Only changed</label>
							</div>
							<hr class="navbar-divider">
							<div id="scans-list"></div>
						</div>
					</div>
				</div>
			</div>
		</nav>
	</section>

	<section>
		<div class="columns">
			<div class="column is-two-thirds">
				<div class="legend is-hidden" id="graph-legend">
					<div class="columns is-desktop">
						<div class="column is-narrow"><div class="legend-entry" id="legend-color-normal"></div></div><div class="column legend-text">Normal</div>
						<div class="column is-narrow"><div class="legend-entry" id="legend-color-first"></div></div><div class="column legend-text">First seen</div>
					</div>
					<div class="columns is-desktop">
						<div class="column is-narrow"><div class="legend-entry" id="legend-color-removed"></div></div><div class="column legend-text">Removed</div>
						<div class="column is-narrow"><div class="legend-entry" id="legend-color-changed"></div></div><div class="column legend-text">Changed</div>
					</div>
					<div class="columns is-desktop">
						<div class="column is-narrow"><div class="legend-entry legend-image" id="legend-color-vulnerable"><img src="/static/assets/icon-os.svg" /></div></div><div class="column legend-text">Vulnerable</div>
						<div class="column is-narrow"><div class="legend-entry legend-image" id="legend-color-windows"><img src="/static/assets/icon-os.svg" /></div></div><div class="column legend-text">NetBIOS</div>
					</div>
				</div>
				<div class="search is-hidden" id="graph-search">
					<div class="field">
						<p class="control has-icons-left">
							<input id="hosts-filter" type="text" placeholder="Search for hosts..." class="input" />
							<span class="icon is-small is-left">
								<i class="fas fa-search"></i>
							</span>
						</p>
					</div>
				</div>
				<div class="view-modes is-size-7 has-text-grey-light">
					<div class="view-menu-item tag is-light"><a id="view-list" title="Display hosts in a table"><img src="/static/assets/view-list.svg" /> List view</a></div>
					<div class="view-menu-item tag is-light"><a id="view-graph" title="Display hosts in a visual graph"><img src="/static/assets/view-graph.svg" /> Graph view</a></div>
					<div class="view-menu-item tag is-white"><a id="hide-removed" title="Toggle 'removed hosts' visibility"><img src="/static/assets/view-removed.svg" /></a></div>
				</div>
				<div class="area-hint is-size-7 has-text-grey-light" id="graph-hint">
					Drag a node to move;<br/>Double-click to reset it's position;
				</div>
				<div id="networkarea"></div>
				<div id="networklist"></div>
			</div>

			<div class="column">
				<div class="scan-info">
					<p><span class="title is-5" id="selected-network"></span> [ <span id="selected-scan"></span> ]</p>
				</div>
				<div class="host-info" id="host-info-box"></div>
				<div class="buttons">
					<a id="btn-pdf" class="button is-info is-light is-fullwidth is-small" download>Download PDF</a>
					<a id="btn-csv" class="button is-info is-light is-fullwidth is-small" download>Download CSV</a>
				</div>
			</div>
		</div>

		<div id="scan-now-modal" class="modal">
			<div class="modal-background"></div>
			<div class="modal-card">
				<header class="modal-card-head"><p class="modal-card-title">Scan triggered</p><button class="delete" aria-label="close"></button></header>
				<section class="modal-card-body">A new scan is triggered and will start shortly.</section>
				<footer class="modal-card-foot"><button class="button is-info">Close</button></footer>
			</div>
		</div>

		<div id="modal-hosts-history" class="modal">
			<div class="modal-background"></div>
			<div class="modal-card">
				<header class="modal-card-head"><p class="modal-card-title">History of: ?</p><button class="delete" aria-label="close"></button></header>
				<section class="modal-card-body">
					<div class="columns">
						<div class="column col-left"><div class="message-body">left</div></div>
						<div class="column col-right"><div class="message-body">right</div></div>
					</div>
				</section>
				<footer class="modal-card-foot"><button class="button">Close</button></footer>
			</div>
		</div>

		<div id="modal-windows-data" class="modal">
			<div class="modal-background"></div>
			<div class="modal-card">
				<header class="modal-card-head"><p class="modal-card-title">Extended Windows-Scan</p><button class="delete" aria-label="close"></button></header>
				<section class="modal-card-body" id="windows-information">
					<p class="subtitle is-5 windows-info">General Information</p>
					<article class="message is-info windows-info">
						<div class="message-body table-container">
							<table class="table is-fullwidth"><tbody class="info-table"></tbody></table>
						</div>
					</article>
					<p class="subtitle is-5 windows-shares">Shares</p>
					<article class="message windows-shares">
						<div class="message-body table-container">
							<table class="table is-striped is-fullwidth"><tbody class="shares-list"></tbody></table>
						</div>
					</article>
					<p class="subtitle is-5 windows-printers">Printer</p>
					<article class="message windows-printers">
						<div class="message-body table-container">
							<table class="table is-striped is-fullwidth"><tbody class="printer-list"></tbody></table>
						</div>
					</article>
				</section>
				<footer class="modal-card-foot"><button class="button">Close</button></footer>
			</div>
		</div>

		<div id="modal-scripts-data" class="modal">
			<div class="modal-background"></div>
			<div class="modal-card">
				<header class="modal-card-head"><p class="modal-card-title">Script-Scans</p><button class="delete" aria-label="close"></button></header>
				<section class="modal-card-body"></section>
				<footer class="modal-card-foot"><button class="button">Close</button></footer>
			</div>
		</div>

		<div id="modal-nse-scripts" class="modal">
			<div class="modal-background"></div>
			<div class="modal-card">
				<header class="modal-card-head"><p class="modal-card-title">Scan-Scripts Management</p><button class="delete" aria-label="close"></button></header>
				<section class="modal-card-body">
					<div class="columns">
						<div class="column is-one-third">
							<ul class="container scripts-list"></ul>
							<div class="columns">
								<div class="column file has-name is-small">
									<label class="file-label">
										<input type="file" class="file-input" name="nse-script" accept=".nse" />
										<span class="file-cta"><span class="file-icon"><i class="fas fa-upload"></i></span><span class="file-label">Choose Script...</span></span>
										<span class="file-name"></span>
									</label>
								</div>
								<div class="column is-narrow">
									<a class="button is-small is-primary" id="nse-script-upload-btn"><span class="icon"><i class="fas fa-upload"></i></span><span>Upload</span></a>
								</div>
							</div>
						</div>
						<div class="column">
							<article class="message">
								<div class="message-body">
									<span class="script-name">Loading...</span><br/>
									<code class="script is-family-monospace">Loading...</code>
									<span class="script-functions has-text-right" style="width:100%;display:inline-block;">
										<a class="button is-small is-warning is-light active"><span class="icon"><i class="fas fa-flag"></i></span></a>
										<a class="button is-small is-danger is-light remove"><span class="icon"><i class="fas fa-trash"></i></span></a>
									</span>
								</div>
							</article>
						</div>
					</div>
				</section>
				<footer class="modal-card-foot"><button class="button">Close</button></footer>
			</div>
		</div>

		<div id="modal-network-config" class="modal">
			<div class="modal-background"></div>
			<div class="modal-card">
				<header class="modal-card-head"><p class="modal-card-title">Operating-System Configuration</p><button class="delete" aria-label="close"></button></header>
				<section class="modal-card-body">
					<div class="columns">
						<div class="column is-one-third">
							<ul class="container scripts-list">
								<li class="os-settings-eth"><a><span class="icon"><i class="fas fa-network-wired"></i></span><span>Ethernet</span></a></li>
								<li class="os-settings-wlan"><a><span class="icon"><i class="fas fa-wifi"></i></span><span>Wireless</span></a></li>
								<li class="os-settings-system"><a><span class="icon"><i class="fas fa-sliders"></i></span><span>System Settings</span></a></li>
							</ul>
						</div>
						<div class="column config-container">
							<section id="os-settings-eth" class="is-hidden content">
								<article class="message">
									<div class="message-body">
										<p class="subtitle is-6">Network Configuration</p>
										<p class="help">The device has a static and a dynamic Network Configuration</p>
										<div class="field">
											<label class="label is-small">Interface</label>
											<div class="select"><select class="is-small full-width" name="os-config-eth-interface"></select></div>
										</div>
										<div class="field">
											<label class="label is-small">IP-Address</label>
											<input class="input is-small full-width" placeholder="A.C.D.E" type="text" name="os-config-eth-ip" value="" />
										</div>
										<div class="field">
											<label class="label is-small">Router</label>
											<input class="input is-small full-width" placeholder="A.C.D.E" type="text" name="os-config-eth-route" value="" />
										</div>
										<div class="field">
											<label class="label is-small">DNS-Servers</label>
											<input class="input is-small full-width" placeholder="A.C.D.E, A.C.D.E" type="text" name="os-config-eth-dns" value="" />
											<p class="help">Separate different DNS by space</p>
										</div>
										<div class="field has-text-right">
											<a class="button is-primary">Save</a>
										</div>
										<p class="help save-status is-hidden">Processing...</p>
									</div>
								</article>
							</section>

							<section id="os-settings-wlan" class="is-hidden content">
								<article class="message">
									<div class="message-body">
										<p class="subtitle is-6">Wireless Configuration</p>
										<div class="field">
											<label class="label is-small">Interface</label>
											<div class="select"><select class="is-small full-width" name="os-config-wlan-interface"></select></div>
										</div>
										<div class="field">
											<label class="label is-small">SSID</label>
											<input class="input is-small full-width" placeholder="" type="text" name="os-config-wlan-ssid" value="" />
										</div>
										<div class="field">
											<label class="label is-small">PSK / Password</label>
											<input class="input is-small full-width" placeholder="" type="password" name="os-config-wlan-psk" value="" />
										</div>
										<div class="field">
											<label class="label is-small">Country Code</label>
											<input class="input is-small full-width" placeholder="2-Char ISO Code Country" type="text" name="os-config-wlan-country" value="" />
											<p class="help">Enter here the 2-Char Country-Code as defined by ISO-3166-1 Alpha-2<br/>This is not relevant if NetworkManager is used</p>
										</div>
										<div class="field has-text-right">
											<a class="button is-primary">Save</a>
										</div>
										<p class="help save-status is-hidden">Processing...</p>
									</div>
								</article>
							</section>

							<section id="os-settings-system" class="is-hidden content">
								<article class="message">
									<div class="message-body">
										<div class="field">
											<a class="button restart is-info">Restart ITScan</a>
										</div>
										<div class="field">
											<a class="button reboot is-warning">Restart System</a>
										</div>
										<div class="field">
											<a class="button reload_network is-warning">Reload Network</a>
										</div>
										<div class="field">
											<a class="button shutdown is-danger">Shutdown System</a>
										</div>
										<div class="field">
											<a class="button reset is-danger">Reset Configuration</a>
										</div>
										<p class="help save-status is-hidden">Processing...</p>
									</div>
								</article>
							</section>

						</div>
					</div>
				</section>
				<footer class="modal-card-foot"><button class="button">Close</button></footer>
			</div>
		</div>

	</section>

	<footer class="footer p-2">
		<div class="content has-text-centered">
			<a href="https://github.com/ITSGmbH/NetworkDiscover">ITScan</a> provided by <a href="https://www.it-s.ch/">IT-S GmbH</a>
		</div>
	</footer>

	<script type="text/javascript">
		var colors = {
			normal: '#d2e5ff',
			first: '#91d782',
			removed: '#eaafa2',
			changed: '#f5ce35'
		};

		function getNodeGroup(os) {
			os = os.toLowerCase().replace("microsoft", "");
			if (os.indexOf("android") >= 0) return "mobile";
			if (os.indexOf("ios") >= 0) return "mobile";
			if (os.indexOf("linux") >= 0) return "linux";
			if (os.indexOf("bsd") >= 0) return "bsd";
			if (os.indexOf("windows server") >= 0) return "server";
			if (os.indexOf("windows") >= 0) return "windows";
			if (os.indexOf("unknown") >= 0) return "unknown";
			return "different";
		}

		function getNodeIcon(os) {
			os = os.toLowerCase();
			if (os.indexOf("android") >= 0 || os.indexOf("ios") >= 0) { return "/static/assets/device-mobile.svg"; }
			if (os.indexOf("linux") >= 0) { return "/static/assets/device-linux.svg"; }
			if (os.indexOf("macos") >= 0) { return "/static/assets/device-apple.svg"; }
			if (os.indexOf("bsd") >= 0) { return "/static/assets/device-bsd.svg"; }
			if (os.indexOf("microsoft") >= 0) { return "/static/assets/device-windows.svg"; }
			if (os.indexOf("juniper") >= 0) { return "/static/assets/device-firewall.svg"; }
			return "/static/assets/device-network.svg";
		}

		function prepareGraph(data, scan) {
			const graph = { nodes: [], edges: [], node_ids: [], root_node: "root" };
			Object.entries(data).forEach(entry => {
				const [k, v] = entry;
				var color = colors.normal;
				if (v.first_scan > 1 && v.first_scan == scan) { color = colors.first; }
				if (v.is_removed) { color = colors.removed; }
				if (v.changed_scan > 1 && v.changed_scan == scan - 1) { color = colors.changed; }

				graph.node_ids.push(v.id);
				graph.nodes.push({
					id: v.id,
					label: v.ip + "\n" + v.os.replace('(', '\n('),
					os: v.os,
					background: color,
					highlight: color,
					first: (v.first_scan > 1 && v.first_scan == scan),
					changed: (v.changed_scan > 1 && v.changed_scan == scan - 1),
					removed: v.is_removed,
					group: v.is_removed ? "delete" : getNodeGroup(v.os),
					extended: v.extended,
					cve: v.has_cve,
				});
				if (v.nodes.length == 0) { graph.root_node = v.id; }
				v.nodes.forEach(val => {
					graph.edges.push({
						source: v.id,
						target: parseInt(val)
					});
				});
			});
			graph.edges.forEach(val => {
				if (!graph.node_ids.includes(val.target)) {
					val.target = graph.root_node;
				}
			});
			if (graph.root_node == "root") {
				graph.nodes.push({
					id: "root",
					label: "",
					background: "#fd8",
					highlight: "#d81",
					removed: false
				});
			}
			delete graph.node_ids;
			return graph;
		}

		const width  = $("#networkarea").width(),
		      height = $("#networkarea").height(),
		      radius = 20,
		      labelsize = 12;

		var selection = { network: 0, scan: 0, nodes: 0 };
		var load_network = ev => {
			$.getJSON("/api/network?network=" + ev.data.network + '&scan=' + ev.data.scan, data => {
				selection.network = ev.data.network;
				selection.scan = ev.data.scan;

				$('#host-info-box').empty();
				$('#btn-pdf').attr('href', '/export/pdf?network=' + ev.data.network + '&scan=' + ev.data.scan);
				$('#btn-csv').attr('href', '/export/csv?network=' + ev.data.network + '&scan=' + ev.data.scan);

				const graph = prepareGraph(data, ev.data.scan);
				createVisualGraph('networkarea', graph);
				createListGraph('networklist', graph);
			});
		}

		// Create a visual representation oof the graph
		function createVisualGraph(id, data) {
			d3.selectAll('#' + id + " > *").remove();
			const svg = d3.select("#" + id)
				.append('svg')
				.attr("viewBox", [ 0, 0, width, height ])
				.attr("style", "max-width: 100%; width: 100%; height: 100%;")
				.call(d3.zoom()
					.scaleExtent([0.1, 5])
					.on("zoom", ev => d3.selectAll('svg g').attr('transform', ev.transform)))
				.on("dblclick.zoom", null);

			// Centric-Force based visualization
			const simulation = d3.forceSimulation()
				.force("link", d3.forceLink().id(d => d.id).distance(200))
				.force("cluster", forceCluster())
				.force("charge", d3.forceManyBody().strength(-1000))
				.force("collision", d3.forceCollide().radius(radius * 1.5))
				.force("center", d3.forceCenter(width/2, height/2));

			// Labels in lowest layer
			const labels = svg.append("g")
				.attr("class", "node-labels")
				.selectAll("text")
					.data(data.nodes)
					.enter()
					.append("text")
					.attr("class", "node-label")
					.attr("font-size", labelsize + "px")
					.attr("fill", "black");
			const label_lines = labels
				.selectAll("tspan")
				.data(d => d.label.split('\n'))
				.enter()
					.append("tspan")
					.text(d => d)
					.attr("text-anchor", "middle")
					.attr("x", 0)
					.attr("dy", labelsize * 1.2);

			// Links behind Nodes
			const links = svg.append("g")
					.attr("class", "links")
					.attr("stroke", "#996666")
					.attr("stroke-width", 1.5)
				.selectAll("line")
					.data(data.edges)
					.enter()
					.append("line")
					.attr("class", "link");

			// Nodes in front
			const nodes = svg.append("g")
				.attr("class", "nodes")
				.attr("stroke-width", "2")
				.attr("stroke-dasharray", "5,5")
				.selectAll("circle")
					.data(data.nodes)
					.enter()
					.append("circle")
					.attr("class", "node")
					.attr("fill", d => d.background)
					.attr("r", radius)
					.attr("id", d => "node-" + d.id);

			// Icon on top of the node
			const icons = svg.append("g")
				.attr("class", "icons")
				.selectAll("image")
					.data(data.nodes)
					.enter()
					.append("image")
					.attr("class", d => {
						if (d.cve) return "vulnerable";
						if (d.extended) return "netbios";
						return "";
					})
					.attr("xlink:href", d => getNodeIcon(d.os ? d.os : 'unknown'))
					.attr("width", radius)
					.attr("height", radius)
				.call(
					d3.drag()
						.on("start", (ev, d) => {
							nodes.classed("selected", false);
							selectNode(d.id)
						})
						.on("drag", (ev, d) => {
							d.fx = ev.x;
							d.fy = ev.y;
							d3.select("#node-" + d.id).classed("fixed", true);
						})
						.on("end", (ev, d) => {
							simulation.alphaTarget(0.1).restart();
						})
				)
				.on("dblclick", (ev, d) => {
					delete d.fx,
					delete d.fy,
					d3.select("#node-" + d.id).classed("fixed", false);
					simulation.alphaTarget(0).restart();
				});

			simulation.nodes(data.nodes).on("tick", () => {
				links
					.attr("x1", d => d.source.x)
					.attr("y1", d => d.source.y)
					.attr("x2", d => d.target.x)
					.attr("y2", d => d.target.y);

				nodes
					.attr("cx", d => d.x)
					.attr("cy", d => d.y);
				labels
					.attr("transform", d => "translate(" + (d.x) + "," + (d.y + radius) + ")");
				icons
					.attr("x", d => d.x - (0.5*radius))
					.attr("y", d => d.y - (0.5*radius));
			});
			simulation.force("link").links(data.edges);
		}

		// Calculate the force center for the G3-Graph
		function centroid(nodes) {
			let x = 0;
			let y = 0;
			let z = 0;
			for (const d of nodes) {
				let k = radius ** 2;
				x += d.x * k;
				y += d.y * k;
				z += k;
			}
			return {x: x / z, y: y / z};
		}
		function forceCluster() {
			let nodes;
			function force(alpha) {
				const centroids = d3.rollup(nodes, centroid, d => d.group);
				const l = alpha * 0.8;
				for (const d of nodes) {
					const { x: cx, y: cy } = centroids.get(d.group);
					d.vx -= (d.x - (cx || 1)) * l;
					d.vy -= (d.y - (cy || 1)) * l;
				}
			}
			force.initialize = n => nodes = n;
			return force;
		}

		// Create a list representation oof the graph
		function createListGraph(id, data) {
			$('#' + id).empty();
			$('#' + id).append('<table class="table"><thead><tr><th>#</th><th>System</th><th>OS</th><th></th></tr></thead><tbody></tbody></table>');
			let live_nodes = appendListNode($('#' + id + ' table tbody'), data.root_node, data, 0, 0);
			$('#' + id + ' table').append('<tfoot><tr><th></th><th></th><th></th><th class="has-text-right">Total online: ' + live_nodes + '</th></tr></tfoot>');
		}
		function appendListNode(table, id, data, count, indent) {
			let node = data.nodes.find((n) => n.id == id);
			if (node == undefined) { return; }

			let tr_class = '';
			let tags = '';
			if (node.cve) { tags += '<span class="tag is-small is-danger">CVEs</span><br/>'; }
			if (node.extended) { tags += '<span class="tag is-small is-info">Extended Information</span><br/>'; }
			if (node.first) { tags += '<span class="tag is-success is-small">first seen</span><br/>'; }
			if (node.changed) { tags += '<span class="tag is-warning is-small">Changed</span><br/>'; }
			if (node.removed && id != 'root') { tags += '<span class="tag is-danger is-light is-small">Removed</span><br/>'; tr_class += 'removed '; } else { count++; }

			let icon = '<figure class="image is-24x24"><img src="' + getNodeIcon(node.os ? node.os : 'unknown') + '" /></figure>';
			let label = node.label.split('\n').reduce((acc, val) => acc + '<br/><small class="has-text-grey">' + val + '</small>');
			let os = node.os;

			let row = $('<tr class="' + tr_class + '"><td>' + icon + '</td><td>' + (label ? label : 'root') + '</td><td>' + os + '</td><td>' + tags + '</td></tr>');
			row.on('click', (ev) => selectNode(id));
			table.append(row);

			data.edges.forEach((n) => {
				if (n.target && n.source && n.target.id == id) {
					count = appendListNode(table, n.source.id, data, count, indent+1);
				}
			});
			return count;
		}

		// Load all scans based on a selected Network
		var load_scans = ev => {
			let changed = $('#scans-changed-only').prop("checked");
			$.getJSON("/api/scans?network=" + ev.data.network, scans => {
				$('#scans-list').empty();
				scans.forEach((v, k) => {
					if (!changed || v.changed == undefined || (v.changed && changed)) {
						$('#scans-list').append('<a class="navbar-item" id="scan-' + k + '">' + getDateString(v.start) + '</a>');
						$('#scan-' + k).on('click', { id: k, network: v.network, scan: v.scan, time: v.start }, click_ev => {
							$('#scans .navbar-item').removeClass('is-active');
							$('#scan-' + click_ev.data.id).addClass('is-active');
							$('#selected-scan').empty();
							$('#selected-scan').append(getDateString(click_ev.data.time));
							load_network(click_ev);
						});
					}
				});
				$('#scan-' + (scans.length - 1)).trigger('click');
			});
		};

		// Manually trigger/start a scan
		var trigger_scan = ev => {
			$.getJSON("/api/scan_now", data => {
				$('#scan-now-modal').toggleClass('is-active');
			});
		}

		$(document).ready(function() {
			// Legend
			$("#legend-color-normal").css("background-color", colors.normal);
			$("#legend-color-first").css("background-color", colors.first);
			$("#legend-color-removed").css("background-color", colors.removed);
			$("#legend-color-changed").css("background-color", colors.changed);

			// Modal dialogs
			$('#scan-now-modal button.delete').on('click', _ev => { $('#scan-now-modal').toggleClass('is-active'); });
			$('#scan-now-modal button.is-info').on('click', _ev => { $('#scan-now-modal').toggleClass('is-active'); });
			$('#modal-hosts-history button.delete').on('click', _ev => { $('#modal-hosts-history').toggleClass('is-active'); });
			$('#modal-hosts-history button.is-info').on('click', _ev => { $('#modal-hosts-history').toggleClass('is-active'); });
			$('#modal-windows-data button.delete').on('click', _ev => { $('#modal-windows-data').toggleClass('is-active'); });
			$('#modal-windows-data button.button').on('click', _ev => { $('#modal-windows-data').toggleClass('is-active'); });
			$('#modal-nse-scripts button.delete').on('click', _ev => { $('#modal-nse-scripts').toggleClass('is-active'); });
			$('#modal-nse-scripts button.button').on('click', _ev => { $('#modal-nse-scripts').toggleClass('is-active'); });
			$('#modal-scripts-data button.delete').on('click', _ev => { $('#modal-scripts-data').toggleClass('is-active'); });
			$('#modal-scripts-data button.button').on('click', _ev => { $('#modal-scripts-data').toggleClass('is-active'); });
			$('#modal-network-config button.delete').on('click', _ev => { $('#modal-network-config').toggleClass('is-active'); });
			$('#modal-network-config button.button').on('click', _ev => { $('#modal-network-config').toggleClass('is-active'); });

			// search events
			$('#scan-now').on('click', { id: 'now'}, trigger_scan);
			$('#scans-search').on('keyup', ev => {
				let val = $('#scans-search').val().toLowerCase();
				if (val == '') {
					$('#scans a.navbar-item').removeClass("is-hidden");
				} else {
					$('#scans a.navbar-item').each((_, elem) => {
						if (elem.innerText.toLowerCase().indexOf(val) == -1) { $(elem).addClass("is-hidden"); }
						else { $(elem).removeClass("is-hidden"); }
					});
				}
			});
			$('#networks-search').on('keyup', ev => {
				let val = $('#networks-search').val().toLowerCase();
				if (val == '') {
					$('#networks a.navbar-item').removeClass("is-hidden");
				} else {
					$('#networks a.navbar-item').each((_, elem) => {
						if (elem.innerText.toLowerCase().indexOf(val) == -1) { $(elem).addClass("is-hidden"); }
						else { $(elem).removeClass("is-hidden"); }
					});
				}
			});
			$('#scans-changed-only').change(ev => {
				load_scans({ data: { network: $('#selected-network').data("network") } });
			});

			// View-Modes (Graph or List, toggle removed)
			$('#view-list').on('click', ev => {
				$('#networklist').removeClass('is-hidden');
				$('#networkarea').addClass('is-hidden');
				$('#graph-legend').addClass('is-hidden');
				$('#graph-search').addClass('is-hidden');
				$('#graph-hint').addClass('is-hidden');
			});
			$('#view-graph').on('click', ev => {
				$('#networklist').addClass('is-hidden');
				$('#networkarea').removeClass('is-hidden');
				$('#graph-legend').removeClass('is-hidden');
				$('#graph-search').removeClass('is-hidden');
				$('#graph-hint').removeClass('is-hidden');
			});
			$('#hide-removed').on('click', ev => {
				$('#networklist table tr.removed').toggleClass('is-hidden');

				const svg = d3.select("#networkarea svg");
				const nodes = svg.selectAll(".nodes circle");
				const links = svg.selectAll(".links line");
				const labels = svg.selectAll(".node-labels text");
				const icons = svg.selectAll(".icons image");
				let hide_nodes = svg.selectAll(".nodes circle.hidden").nodes().length == 0;

				nodes.attr("class", "node");
				links.attr("class", "link");
				labels.attr("class", "node-label");
				icons.attr("class", "");

				if (hide_nodes) {
					nodes.attr("class", "node")
						.filter(node => node.removed)
						.attr("class", "node hidden")
						.each(node => {
							links.filter(link => link.source.id == node.id || link.target.id == node.id)
								.attr("class", "link hidden");
							labels.filter(label => label.id == node.id)
								.attr("class", "node-label hidden");
							icons.filter(label => label.id == node.id)
								.attr("class", "hidden");
						});
				}
			});

			// Load all Networks
			$.getJSON("/api/networks", data => {
				$('#networks-list').empty();
				data.forEach((v, k) => {
					var name = v.name + ( v.name != "" ? " (" : "" ) + v.network + ( v.name != "" ? ")" : "" );
					$('#networks-list').append('<a class="navbar-item" id="network-' + k + '">' + name + '</a>');
					$('#network-' + k).on('click', { id: k, network: v.network, name: name }, click_ev => {
						$('#networks .navbar-item').removeClass('is-active');
						$('#network-' + k).addClass('is-active');
						$('#selected-network').empty();
						$('#selected-network').append(click_ev.data.name);
						$('#selected-network').data("network", click_ev.data.network);
						load_scans(click_ev);
					});
					$('#network-' + k).data('network', v);
				});
				$('#network-0').trigger('click');
			}).fail(function() {
				console.error("Error while loading Networks.");
			});

			// NSE Script Management
			var selected_script = '';
			var set_script_content = (script, content, active) => {
				let code = content
					.replace(/\</g, '&lt;')
					.replace(/\>/g, '&gt;')
					.replace(/  |\t/g, '&nbsp;&nbsp;');
				$('#modal-nse-scripts .script-name').html(script);
				$('#modal-nse-scripts .script').html(code);
			};
			var add_script_elem = (script) => {
				if ($('#modal-nse-scripts .scripts-list li a span').filter((_, elem) => $(elem).text().trim() == script.trim()).length > 0) {
					return;
				}
				var elem = $('<li><a class="script-list-name"><span class="icon"><i class="fas fa-file-text"></i></span><span>' + script + '</span></a></li>')
					.on('click', { script: script }, ev => {
						selected_script = ev.data.script;
						$.getJSON("/api/script/load", { script: selected_script }, data => set_script_content(data.script, data.content, data.active) );
					});
				$('#modal-nse-scripts .scripts-list').append(elem);
			};
			$('#btn-nse').on('click', () => {
				$('#modal-nse-scripts').toggleClass('is-active');
				selected_script = '';
				$.getJSON("/api/script/list", data => {
					$('#modal-nse-scripts .script').empty();
					$('#modal-nse-scripts .script-name').empty();
					$('#modal-nse-scripts .scripts-list').empty();
					$(data).each((_, script) => add_script_elem(script));
				});
			});
			$('#modal-nse-scripts .script-functions .active').on('click', ev => {
				$.getJSON("/api/script/activate", { script: selected_script }, data => {
					console.debug("(De-)Activated: ", data);
				});
			});
			$('#modal-nse-scripts .script-functions .remove').on('click', ev => {
				$.getJSON("/api/script/delete", { script: selected_script }, data => {
					$('#modal-nse-scripts .scripts-list li').each((_, elem) => {
						if ($("a span", elem).filter((_, elem) => $(elem).text().trim() == selected_script.trim()).length > 0) {
							$(elem).remove();
						}
					});
					$('#modal-nse-scripts .script').empty();
					$('#modal-nse-scripts .script-name').empty();
					selected_script = '';
				});
			});
			$('#modal-nse-scripts input[name="nse-script"]').on("change", ev => {
				if (ev.target.files.length > 0) {
					$('#modal-nse-scripts .file-name').html(ev.target.files[0].name);
				}
			});
			$('#nse-script-upload-btn').on('click', () => {
				var input = $('#modal-nse-scripts input[name="nse-script"]').prop('files');
				if (input.length > 0) {
					const reader = new FileReader();
					reader.addEventListener('load', evt => {
						$.ajax("/api/script/upload", {
							type: 'POST',
							contentType: 'application/json',
							data: JSON.stringify({
								script: input[0].name,
								content: evt.target.result
							}),
							success: resp => {
								$('#modal-nse-scripts .file-name').empty();
								$('#modal-nse-scripts input[name="nse-script"]').val(null);
								selected_script = resp.script;
								add_script_elem(resp.script);
								set_script_content(resp.script, resp.content, resp.active);
							},
						});
					});
					reader.readAsDataURL(input[0]);
				}
			});

			// System Configuration Dialog and Functions
			$('#modal-network-config ul.container li').on('click', ev => {
				$('#modal-network-config .config-container section').removeClass('is-hidden').addClass('is-hidden');
				$('#' + ev.currentTarget.className).removeClass('is-hidden');
			});
			$('#btn-osconfig').on('click', () => {
				$('#modal-network-config').toggleClass('is-active');
				$.getJSON("/api/settings", data => {
					if (Array.isArray(data.interfaces)) {
						$('#os-settings-eth [name="os-config-eth-interface"]').empty();
						$('#os-settings-eth [name="os-config-wlan-interface"]').empty();
						data.interfaces.forEach((val) => {
							$('#os-settings-eth [name="os-config-eth-interface"]').append($('<option>', { value: val, text: val }));
							$('#os-settings-wlan [name="os-config-wlan-interface"]').append($('<option>', { value: val, text: val }));
						});
					}
					if (data.network) {
						$('#os-settings-eth [name="os-config-eth-interface"]').prop('value', data.network.interface);
						$('#os-settings-eth [name="os-config-eth-ip"]').prop('value', data.network.ip);
						$('#os-settings-eth [name="os-config-eth-route"]').prop('value', data.network.router);
						$('#os-settings-eth [name="os-config-eth-dns"]').prop('value', data.network.dns);
					}
					if (data.wireless) {
						$('#os-settings-wlan [name="os-config-wlan-interface"]').prop('value', data.wireless.interface);
						$('#os-settings-wlan [name="os-config-wlan-ssid"]').prop('value', data.wireless.ssid);
						$('#os-settings-wlan [name="os-config-wlan-psk"]').prop('value', data.wireless.psk);
						$('#os-settings-wlan [name="os-config-wlan-country"]').prop('value', data.wireless.country);
					}
				});
			});
			$('#os-settings-eth a.button').on('click', ev => {
				$('#os-settings-eth .save-status').removeClass('is-hidden');
				$.ajax('/api/settings', {
					type: 'POST',
					contentType: 'application/json',
					data: JSON.stringify({
						network: {
							interface: $('#os-settings-eth [name="os-config-eth-interface"]').prop('value').trim() ? $('#os-settings-eth [name="os-config-eth-interface"]').prop('value') : null,
							ip: $('#os-settings-eth [name="os-config-eth-ip"]').prop('value').trim() ? $('#os-settings-eth [name="os-config-eth-ip"]').prop('value') : null,
							router: $('#os-settings-eth [name="os-config-eth-route"]').prop('value').trim() ? $('#os-settings-eth [name="os-config-eth-route"]').prop('value') : null,
							dns: $('#os-settings-eth [name="os-config-eth-dns"]').prop('value').trim() ? $('#os-settings-eth [name="os-config-eth-dns"]').prop('value') : null,
						}
					}),
					complete: () => $('#os-settings-eth .save-status').addClass('is-hidden')
				});
			});
			$('#os-settings-wlan a.button').on('click', ev => {
				$('#os-settings-wlan .save-status').removeClass('is-hidden');
				$.ajax('/api/settings', {
					type: 'POST',
					contentType: 'application/json',
					data: JSON.stringify({
						wireless: {
							interface: $('#os-settings-wlan [name="os-config-wlan-interface"]').prop('value').trim() ? $('#os-settings-wlan [name="os-config-wlan-interface"]').prop('value') : null,
							ssid: $('#os-settings-wlan [name="os-config-wlan-ssid"]').prop('value').trim() ? $('#os-settings-wlan [name="os-config-wlan-ssid"]').prop('value') : null,
							psk: $('#os-settings-wlan [name="os-config-wlan-psk"]').prop('value').trim() ? $('#os-settings-wlan [name="os-config-wlan-psk"]').prop('value') : null,
							country: $('#os-settings-wlan [name="os-config-wlan-country"]').prop('value').trim() ? $('#os-settings-wlan [name="os-config-wlan-country"]').prop('value') : null,
						}
					}),
					complete: () => $('#os-settings-wlan .save-status').addClass('is-hidden')
				});
			});
			$('#os-settings-system a.button').on('click', ev => {
				$('#os-settings-system .save-status').removeClass('is-hidden');
				$.ajax('/api/settings', {
					type: 'POST',
					contentType: 'application/json',
					data: JSON.stringify({
						system: {
							restart: ev.currentTarget.classList.contains('restart'),
							reload_network: ev.currentTarget.classList.contains('reload_network'),
							reboot: ev.currentTarget.classList.contains('reboot'),
							shutdown: ev.currentTarget.classList.contains('shutdown'),
							reset: ev.currentTarget.classList.contains('reset'),
						}
					}),
					complete: () => $('#os-settings-system .save-status').addClass('is-hidden')
				});
			});


			// File Input Form in configuration for the Logo
			$('#config [name="logo"]').on("change", ev => {
				if (ev.target.files.length > 0) {
					$('#file-js-logo .file-name').html(ev.target.files[0].name);
				}
			});
			$('#clear-white-label').on('click', ev => {
				ev.stopPropagation();
				$('#config [name="logo"]').prop('value', '');
				$('#file-js-logo .file-name').html('');
				$('#config [name="color"]').prop('value', '');
				$('#config [name="tagline"]').prop('value', '');
				$('#config [name="update_check"]').prop('value', '');
			});


			// Add Network-Config-Handler
			let add_network = () => {
				let num = $('#config-network .tabs ul li').length + 1;
				$('#config-network .tabs ul').append($('<li id="config-network-' + num + '-tab"><a>#' + num + '</a></li>'));
				$('#config-network').append($('<div class="block tabs-block is-hidden" id="config-network-' + num + '">' +
					'<div class="field">' +
					'<label class="label is-small">Name</label>' +
					'<input class="input is-small full-width" placeholder="" type="text" name="target-' + num + '-name" value="" />' +
					'</div><div class="field">' +
					'<label class="label is-small">Network/mask</label>' +
					'<input class="input is-small full-width" placeholder="" type="text" name="target-' + num + '-network" value="" />' +
					'</div><div class="field">' +
					'<label class="checkbox"><input type="checkbox" name="target-' + num + '-extended" value="true" /> Vulnerability Scan</label>' +
					'</div><div class="field">' +
					'<label class="checkbox"><input type="checkbox" name="target-' + num + '-version" value="true" /> Try to determine Service Version/Info</label>' +
					'</div><div class="field">' +
					'<label class="checkbox"><input type="checkbox" name="target-' + num + '-windows" class="windows-config-selector" value="true" /> Windows Scan</label>' +
					'</div><div id="target-' + num + '-windows-container">' +
					'<div class="field">' +
					'<label class="label is-small">Windows Domain</label>' +
					'<input class="input is-small full-width" placeholder="" type="text" name="target-' + num + '-windom" value="" />' +
					'</div><div class="field">' +
					'<label class="label is-small">Windows Domain User</label>' +
					'<input class="input is-small full-width" placeholder="" type="text" name="target-' + num + '-winuser" value="" />' +
					'</div><div class="field">' +
					'<label class="label is-small">Password</label>' +
					'<input class="input is-small full-width" placeholder="" type="password" name="target-' + num + '-winpass" value="" />' +
					'</div></div></div>'));

					// Show network config tab and hide others
					$('#config-network-' + num + '-tab').on('click', ev => {
						$('#config-network .tabs li').removeClass('is-active');
						$('#config-network .tabs-block').removeClass('is-hidden').addClass('is-hidden');
						$('#config-network-' + num + '-tab').addClass('is-active');
						$('#config-network-' + num).removeClass('is-hidden');
					});

					// Show Windows-config only when checked
					$('#target-' + num + '-windows').on('click', ev => {
						if (elem.prop('checked')) {
							$('#target-' + num + '-windows-container').removeClass('is-hidden');
						} else {
							$('#target-' + num + '-windows-container').addClass('is-hidden');
						}
					});

					// Select the network tab
					$('#config-network-' + num + '-tab').trigger('click');
					return num;
			};
			$('#add-network-config').on('click', ev => add_network());

			// Load the Configuration
			$.getJSON("/api/config", data => {
				$('#config [name="repeat"]').prop('value', data.repeat);
				$('#config [name="threads"]').prop('value', data.num_threads);
				$('#config [name="interface"]').prop('value', data.device);
				$('#config [name="script-arguments"]').prop('value', data.script_args);

				if (data.whitelabel) {
					$('#file-js-logo .file-name').html(data.whitelabel.logo);
					$('#config [name="color"]').prop('value', data.whitelabel.color);
					$('#config [name="tagline"]').prop('value', data.whitelabel.tagline);
					$('#config [name="update_check"]').prop('value', data.whitelabel.update_check);
				} else {
					$('#config [name="color"]').prop('value', '');
				}

				if (data.listen) {
					$('#config [name="listen-ip"]').prop('value', data.listen.ip);
					$('#config [name="listen-port"]').prop('value', data.listen.port);
				}

				if (data.sqlite) {
					$('#config [name="db-path"]').prop('value', data.sqlite.file);
					$('#config [name="db-url"]').prop('value', data.sqlite.url);
				}

				if (data.targets && data.targets.forEach) {
					data.targets.forEach((v, k) => {
						idx = add_network();
						$('#config [name="target-' + idx + '-name"]').prop('value', v.target.name);
						$('#config [name="target-' + idx + '-network"]').prop('value', v.target.ip + '/' + v.target.mask);
						$('#config [name="target-' + idx + '-extended"]').prop('checked', v.extended);
						$('#config [name="target-' + idx + '-version"]').prop('checked', v.version_check);
						if (v.windows) {
							$('#config [name="target-' + idx + '-windows"]').prop('checked', true);
							$('#config [name="target-' + idx + '-windom"]').prop('value', v.windows.domain);
							$('#config [name="target-' + idx + '-winuser"]').prop('value', v.windows.domain_user);
							$('#config [name="target-' + idx + '-winpass"]').prop('value', v.windows.password);
						} else {
							$('#target-' + idx + '-windows-container').addClass('is-hidden');
						}
					});

					// Select teh first network as default
					$('#config-network-1-tab').trigger('click');
				}

				$('#config-save').on('click', function() {
					$('#config-save').attr('disabled', 'disabled');
					config = {
						repeat: $('#config [name="repeat"]').prop('value').trim() ? $('#config [name="repeat"]').prop('value') : '0 * * * *',
						num_threads: $('#config [name="threads"]').prop('value').trim() ? parseInt($('#config [name="threads"]').prop('value')) : null,
						device: $('#config [name="interface"]').prop('value').trim() ? $('#config [name="interface"]').prop('value').trim() : null,
						script_args: $('#config [name="script-arguments"]').prop('value').trim() ? $('#config [name="script-arguments"]').prop('value').trim() : null,
						listen: $('#config [name="listen-ip"]').prop('value').trim() ? {
						 ip: $('#config [name="listen-ip"]').prop('value').trim(),
						 port: parseInt($('#config [name="listen-port"]').prop('value')),
						} : null,
						sqlite: $('#config [name="db-path"]').prop('value').trim() || $('#config [name="db-url"]').prop('value').trim() ? {
						 file: $('#config [name="db-path"]').prop('value').trim() ? $('#config [name="db-path"]').prop('value').trim() : null,
						 url: $('#config [name="db-url"]').prop('value').trim() ? $('#config [name="db-url"]').prop('value').trim() : null,
						} : null,
						targets: [],
						whitelabel: {
							logo: ($('#config [name="logo"]').prop('files').length > 0) ? $('#config [name="logo"]')[0].files[0].name : null,
							logo_data: null,
							color: $('#config [name="color"]').prop('value').trim() ? $('#config [name="color"]').prop('value').trim() : null,
							tagline: $('#config [name="tagline"]').prop('value').trim() ? $('#config [name="tagline"]').prop('value').trim() : null,
							update_check: $('#config [name="update_check"]').prop('value').trim() ? $('#config [name="update_check"]').prop('value').trim() : null,
						},
					};

					$('#config-network .tabs ul li').each(k => {
						let idx = config.targets.length;
						var id = "target-" + (k + 1);
						if ($('#config [name="' + id + '-name"]').prop('value').trim()) {
							var nw = $('#config [name="' + id + '-network"]').prop('value').trim().split("/");
							config.targets[idx] = {
								extended: $('#config [name="' + id + '-extended"]').prop('checked'),
								version_check: $('#config [name="' + id + '-version"]').prop('checked'),
								target: {
									name: $('#config [name="' + id + '-name"]').prop('value').trim(),
									ip: nw[0].trim(),
									mask: parseInt(nw[1]),
								}
							};
							if ($('#config [name="' + id + '-windows"]').prop('checked')) {
								config.targets[idx].windows = {
									domain: $('#config [name="' + id + '-windom"]').prop('value').trim() ? $('#config [name="' + id + '-windom"]').prop('value').trim() : null,
									domain_user: $('#config [name="' + id + '-winuser"]').prop('value').trim() ? $('#config [name="' + id + '-winuser"]').prop('value').trim() : null,
									password: $('#config [name="' + id + '-winpass"]').prop('value').trim() ? $('#config [name="' + id + '-winpass"]').prop('value').trim() : null,
								};
							}
						}
					});

					// Save-Config function
					var save_config = config => {
						$.ajax("/api/config", {
							type: 'POST',
							contentType: 'application/json',
							data: JSON.stringify(config),
							success: function(resp) {
								setTimeout(function() {$('#config-save').removeAttr('disabled');}, 1500);
							},
						});
					};

					// Encode the logo as base64 before saveing
					if ($('#config [name="logo"]').prop('files').length > 0) {
						const reader = new FileReader();
						reader.addEventListener('load', evt => {
							config.whitelabel.logo_data = evt.target.result;
							save_config(config);
						});
						reader.readAsDataURL($('#config [name="logo"]').prop('files')[0]);

					} else {
						if (!config.whitelabel.color && !config.whitelabel.tagline && !config.whitelabel.update_check) {
							config.whitelabel = null;
						}
						save_config(config);
					}
				});
			}).fail(function() {
				console.error("Error while fetching configuration.");
			});

			// Setup the Hosts-Filter for D3
			$('#hosts-filter').on('keyup', evt => {
				let val = $('#hosts-filter').val().toLowerCase();

				const svg = d3.select("#networkarea svg");
				const nodes = svg.selectAll(".nodes circle");
				const links = svg.selectAll(".links line");
				const labels = svg.selectAll(".node-labels text");
				const icons = svg.selectAll(".icons image");

				links.attr("class", "link");
				labels.attr("class", "node-label");
				icons.attr("class", "");

				nodes.attr("class", "node")
					.filter(node => (node.label.toLowerCase().indexOf(val) == -1))
					.attr("class", "node hidden")
					.each(node => {
						links.filter(link => link.source.id == node.id || link.target.id == node.id)
							.attr("class", "link hidden");
						labels.filter(label => label.id == node.id)
							.attr("class", "node-label hidden");
						icons.filter(label => label.id == node.id)
							.attr("class", "hidden");
					});
			});

			// Check for the scan-status every 5 seconds
			window.setInterval(function() {
				$.getJSON("/api/status", data => {
					message = 'waiting';
					if (data.running) {
						message = "running";
					} else if (data.paused) {
						message = "paused";
					} else if (data.triggered) {
						message = "started";
					}
					$('#running-status').addClass('is-warning');
					$('#running-status').removeClass('is-danger');
					$('#running-status').html(message);
				})
				.fail(err => {
					$('#running-status').addClass('is-danger');
					$('#running-status').removeClass('is-warning');
					$('#running-status').html('check failed...');
				});
			}, 5000);

			// Check for an update on every reload
			$.getJSON("/api/version", data => {
				if (data.installed != data.latest) {
					$('#release-version').addClass('is-danger');
					$('#release-version').removeClass('is-success');
					$('#release-version').html("Latest Release: " + data.latest + ' - Installed Version: ' + data.installed);
				} else {
					$('#release-version').addClass('is-success');
					$('#release-version').removeClass('is-danger');
					$('#release-version').html("Up to date");
				}
			});
		});

		// Returns a formatted date string based on the given timestamp
		function getDateString(timestamp) {
			return (new Date(timestamp)).toLocaleString();
		}

		// Show information about a specific host
		function fill_host_info_box(cont, data, with_hist) {
			if (with_hist) {
				$('.message-body', cont).append('<div class="dropdown is-hoverable"><div class="dropdown-trigger"><div class="mouse-pointer" aria-haspopup="true" aria-controls="dropdown-menu" style="display:flex;"><figure class="image is-24x24"><img src="/static/assets/icon-date.svg" /></figure><span class="pl-2">' + getDateString(data.scan_timestamp) + '</span></div></div><div class="dropdown-menu" id="dropdown-menu" role="menu"><div class="dropdown-content" id="host-scan-host-list"></div></div></div>');
			} else {
				$('.message-body', cont).append('<div style="display:flex;"><figure class="image is-24x24"><img src="/static/assets/icon-windows.svg" /></figure><span class="pl-2">' + getDateString(data.scan_timestamp) + '</span></div>');
			}
			$('.message-body', cont).append('<div class="pt-1" style="display:flex;"><figure class="image is-24x24"><img src="/static/assets/icon-os.svg" /></figure><span class="pl-2">' + data.os + '</span></div>');

			// Windows Data
			if (data.windows && with_hist) {
				$('.message-body', cont)
					.append('<div id="extended-windows-scan-button" class="mouse-pointer pt-1" style="display:flex;"><figure class="image is-24x24"><img src="/static/assets/icon-windows.svg" /></figure><span class="pl-2">Extended Windows-Information</span></div>');
				$('#extended-windows-scan-button', cont).on('click', ev => {
					$('#modal-windows-data').toggleClass('is-active');
				});

				// General information
				var win_info = $('#modal-windows-data .windows-info');
				var table_info = $('#modal-windows-data .info-table');
				table_info.empty();
				for (key in data.windows.info) {
					var val = data.windows.info[key];
					table_info.append('<tr><th>' + key.replaceAll('_', ' ') + '</th><td>' + (val == null ? "" : val) + '</td></tr>');
				}
				for (key in data.windows.domain) {
					var val = data.windows.domain[key];
					table_info.append('<tr><th>' + key.replaceAll('_', ' ') + '</th><td>' + (val == null ? "" : val) + '</td></tr>');
				}

				// Shares
				var win_shares = $('#modal-windows-data .windows-shares');
				var table_shares = $('#modal-windows-data .shares-list');
				table_shares.empty();
				win_shares.removeClass("is-hidden");
				if (data.windows.shares.length == 0) { win_shares.addClass("is-hidden"); }
				for (key in data.windows.shares) {
					var share = data.windows.shares[key];
					table_shares.append('<tr><th>' + share.name + '</th><td><em>' + share.share_type + '</em></td><td>' + share.comment + '</td></tr>');
				}

				// Printers
				var win_printers = $('#modal-windows-data .windows-printers');
				var table_printers = $('#modal-windows-data .printer-list');
				table_printers.empty();
				win_printers.removeClass("is-hidden");
				if (data.windows.printers.length == 0) { win_printers.addClass("is-hidden"); }
				for (key in data.windows.printers) {
					var printer = data.windows.printers[key];
					table_printers.append('<tr><th>' + printer.uri + '</th><td><em>' + printer.description + '</em></td><td>' + printer.comment + '</td></tr>');
				}
			}

			// Script-Scan
			if (data.scripts.length > 0 && with_hist) {
				$('.message-body', cont)
					.append('<div id="script-scan-button" class="mouse-pointer pt-1" style="display:flex;"><figure class="image is-24x24"><img src="/static/assets/icon-script.svg" /></figure><span class="pl-2">Script-Scan Data</span></div>');
				$('#script-scan-button', cont).on('click', ev => {
					$('#modal-scripts-data').toggleClass('is-active');
				});

				// Script-Scan-Data
				var scripts_container = $('#modal-scripts-data .modal-card-body');
				scripts_container.empty();

				for (key in data.scripts) {
					let script = data.scripts[key];
					var script_container = $('<p class="subtitle is-5 script-title">' + script.name + '</p><article class="message"><div class="message-body table-container"><table class="table is-striped is-fullwidth"><tbody class="script-data"></tbody></table></div></article>');
					scripts_container.append(script_container);
					let data_table = $('.script-data', script_container);

					for (k in script.data) {
						var elem = script.data[k];
						data_table.append('<tr><th>' + elem.key + '</th><td>' + elem.value + '</td></tr>');
					}
				}
			}

			// Ports and CVEs
			var table = $('.message-body', cont).append('<div class="mt-4 table-container"><table class="table is-striped is-fullwidth"><tbody class="mainbody"></tbody></table></div>');
			data.ports.forEach(port => {
				var id = 'cve_' + data.ip.replace(/\./gi, '_') + '-' + port.port + '_' + port.protocol;
				$('tbody.mainbody', table).append('<tr><td>' + port.port + '/' + port.protocol + '<br/>' + port.service + '</td><td>' + port.product + '</td><td id="' + id + '"></td></tr>');

				if (port.cves.length > 0) {
					$('#' + id, table).append('<button class="button is-small is-danger is-light">CVEs</button>');
					var header = $('<header class="modal-card-head"><p class="modal-card-title">CVEs of ' + data.ip + ', Port ' + port.port + '/' + port.protocol + '</p><button class="delete" aria-label="close"></button></header>');
					var cves = $('<section class="modal-card-body"><table class="table is-fullwidth"><tbody class="cvebody"></tbody></table></section>');

					port.cves.sort((a, b) => a.cvss < b.cvss);
					port.cves.sort((a, b) => a.database < b.database);
					var last_db = '';
					port.cves.forEach(cve => {
						if (cve.database.length == 0 && cve.id.length == 0)
							return;
						var link = 'https://vulners.com/' + cve.database + '/' + cve.id;
						if (last_db != cve.database) {
							$('tbody.cvebody', cves).append('<tr><th colspan="3">' + cve.database + '</th></tr>');
						}
						$('tbody.cvebody', cves).append('<tr><td><a target="_blank" href="' + link + '">' + cve.id + '</a></td><td>' + (cve.exploit ? '<span class="tag is-danger">Exploit</span>' : '') + '</td><td>' + cve.cvss + '</td></tr>');
						last_db = cve.database;
					});

					$('#' + id, table).append('<div id="' + id + '-modal" class="modal"><div class="modal-background"></div><div class="modal-card"></div></div>')
					$('#' + id + ' .modal-card', table).append(header);
					$('#' + id + ' .modal-card', table).append(cves);

					$('#' + id + ' button.button', table).on('click', { id: id }, _ev => { $('#' + _ev.data.id + '-modal').toggleClass('is-active'); });
					$('#' + id + ' button.delete', table).on('click', { id: id }, _ev => { $('#' + _ev.data.id + '-modal').toggleClass('is-active'); });
				}
			});
		}

		// Unselect a node
		function unselectNode(node) {
			var selected = (node == selection.nodes);
			$('#host-info-box').empty();
			selection.nodes = 0;
			return selected;
		}

		// Load data from a selected node and display it on success
		function selectNode(node) {
			if (!unselectNode(node)) {
				selection.nodes = node;
				d3.select("#node-" + selection.nodes).classed("selected", true);

				$.getJSON("/api/info?network=" + selection.network + "&scan=" + selection.scan + "&host=" + selection.nodes, data => {
					var cont = $('<article class="message"><div class="message-header"><p>' + data.ip + '</p></div><div class="message-body"></div></article>');
					fill_host_info_box(cont, data, true);

					data.scan_history.forEach(hist => {
						$('#host-scan-host-list', cont).append('<div class="dropdown-item mouse-pointer" data-scan="' + hist.scan + '"><strong>' + hist.scan + ':</strong> ' + getDateString(hist.start) + '</div>');
					});
					$('#host-scan-host-list .mouse-pointer', cont).on('mouseover', ev => {
						$(ev.target).toggleClass("has-background-info").toggleClass("has-text-grey-lighter");
					});
					$('#host-scan-host-list .mouse-pointer', cont).on('mouseout', ev => {
						$(ev.target).toggleClass("has-background-info").toggleClass("has-text-grey-lighter");
					});

					// Fill Hosts-History
					$('#host-scan-host-list .dropdown-item', cont).on('click', _ev => {
						$.getJSON("/api/info?network=" + selection.network + "&scan=" + selection.scan + "&host=" + selection.nodes, hist_data => {
							$('#modal-hosts-history .modal-card .message-body').empty();
							$('#modal-hosts-history .modal-card-title').empty();
							$('#modal-hosts-history .modal-card-title').append('History of: ' + hist_data.ip);
							fill_host_info_box($('#modal-hosts-history .modal-card .col-left'), hist_data, false);
							fill_host_info_box($('#modal-hosts-history .modal-card .col-right'), data, false);
							$('#modal-hosts-history').toggleClass('is-active');
						});
					});

					$('#host-info-box').append(cont);
				});
			}
		}

	</script>
</body>
</html>
