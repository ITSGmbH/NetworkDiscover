<!DOCTYPE html>
<html>
<head>
	<title>Network</title>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta charset="utf-8">
	<script type="text/javascript" src="/static/js/jquery.min.js"></script>
	<script src="https://d3js.org/d3.v7.min.js"></script>
	<link rel="stylesheet" href="/static/css/bulma.min.css">
	<link rel="stylesheet" href="/static/css/fa-all.min.css">
	<link rel="icon" type="image/png" href="/static/img/its_logo.png">
	<style type="text/css">
		#networkarea {
			width: 100%;
			height: 85vh;
			border: 1px solid lightgray;
		}
		#scan-now-modal .modal-card-body {
			color: black;
		}
		#host-info-box {
			margin-bottom: 0.75rem;
		}
		#config .input.full-width { width: 18rem; }
		#config .input.double-big { width: 13rem; }
		#config .input.double-small { width: 5rem; }
		.mouse-pointer {
			cursor: pointer;
		}
		.navbar-dropdown {
			max-height: 90vh;
			overflow-y: scroll;
		}

		.legend {
			position: absolute;
			z-index: 999;
			top: 60px;
			left: 0px;
			border: 1px solid lightgray;
			background: white;
			padding: 0.6rem;
			padding-bottom: 0;
			font-size: 0.75rem;
		}
		.legend .columns {
			margin-bottom: 0;
		}
		.legend .column {
			padding: 0.6rem;
		}
		.legend .legend-text {
			white-space: nowrap;
			width: 6vw;
		}
		.legend .legend-entry {
			border: 1px solid #2B7CE9;
			border-radius: 50%;
			width: 16px;
			height: 16px;
		}
		.scan-info {
			margin: 1rem 0;
		}

		svg .node-label tspan {
			fill-opacity: 0.4;
		}
		svg .node-label tspan:first-child {
			fill-opacity: 1;
			font-weight: bold;
		}
	</style>
	</style>
</head>
<body>
	<section class="section pb-3">
		<nav class="navbar is-info is-fixed-top" role="navigation" aria-label="dropdown navigation">
			<div class="navbar-menu">
				<div class="navbar-brand">
					<span class="navbar-item"><img src="/static/img/its_logo.png" alt="IT-S" height="12" /></span>
					<h1 class="navbar-item title is-4">NetworkDiscovery</h1>
				</div>

				<div class="navbar-start">
					<div class="navbar-item"><span class="tag is-warning" id="running-status">...</span></div>
				</div>

				<div class="navbar-end">

					<div class="navbar-item has-dropdown has-dropdown is-hoverable">
						<span class="navbar-link">Config</span>
						<fieldset class="navbar-dropdown is-right" id="config">

							<div class="navbar-item">
								<div class="box">
									<p class="subtitle is-6">System</p>
									<div class="field">
										<label class="label is-small">Scan every (hours)</label>
										<input class="input is-small full-width" placeholder="24" type="number" name="repeat" value="" />
									</div>
									<div class="field">
										<label class="label is-small">Threads to scan</label>
										<input class="input is-small full-width" placeholder="10" type="number" name="threads" value="" />
									</div>
									<div class="field">
										<label class="label is-small">Device name for auto config</label>
										<input class="input is-small full-width" placeholder="None" type="text" name="interface" value="" />
									</div>
								</div>
							</div>

							<div class="navbar-item">
								<div class="box">
									<p class="subtitle is-6">Configuration</p>
									<div class="field">
										<label class="label is-small">Configuration name</label>
										<input class="input is-small full-width" placeholder="LocalNet" type="text" name="name" value="" />
									</div>
									<div class="field">
										<label class="label is-small">Web-Listener</label>
										<input class="input is-small double-big" type="text" placeholder="0.0.0.0" name="listen-ip" value="" />
										<input class="input is-small double-small" type="number" placeholder="9090" name="listen-port" value="" />
									</div>
									<div class="field">
										<label class="label is-small">Database-Path</label>
										<input class="input is-small full-width" placeholder="" type="text" name="db-path" value="" />
									</div>
									<div class="field">
										<label class="label is-small">Database-URL</label>
										<input class="input is-small full-width" placeholder="" type="text" name="db-url" value="" />
									</div>
								</div>
							</div>

							<div class="navbar-item">
								<div class="box" id="config-network">
									<p class="subtitle is-6">Networks</p>

									<div class="block tabs is-centered">
										<ul>
											<li class="is-active" id="config-network-1-tab"><a>#1</a></li>
											<li id="config-network-2-tab"><a>#2</a></li>
											<li id="config-network-3-tab"><a>#3</a></li>
											<li id="config-network-4-tab"><a>#4</a></li>
											<li id="config-network-5-tab"><a>#5</a></li>
										</ul>
									</div>

									<div class="block tabs-block" id="config-network-1">
										<div class="field">
											<label class="label is-small">Name</label>
											<input class="input is-small full-width" placeholder="" type="text" name="target-1-name" value="" />
										</div>
										<div class="field">
											<label class="label is-small">Network/mask</label>
											<input class="input is-small full-width" placeholder="" type="text" name="target-1-network" value="" />
										</div>
										<div class="field">
											<label class="label is-small">Maximum Hops</label>
											<input class="input is-small full-width" placeholder="" type="text" name="target-1-hops" value="" />
										</div>
										<div class="field">
											<label class="checkbox">
												<input type="checkbox" name="target-1-extended" value="true" />
												Extended Scan
											</label>
										</div>
									</div>
									<div class="block tabs-block is-hidden" id="config-network-2">
										<div class="field">
											<label class="label is-small">Name</label>
											<input class="input is-small full-width" placeholder="" type="text" name="target-2-name" value="" />
										</div>
										<div class="field">
											<label class="label is-small">Network/mask</label>
											<input class="input is-small full-width" placeholder="" type="text" name="target-2-network" value="" />
										</div>
										<div class="field">
											<label class="label is-small">Maximum Hops</label>
											<input class="input is-small full-width" placeholder="" type="text" name="target-2-hops" value="" />
										</div>
										<div class="field">
											<label class="checkbox">
												<input type="checkbox" name="target-2-extended" value="true" />
												Extended Scan
											</label>
										</div>
									</div>
									<div class="block tabs-block is-hidden" id="config-network-3">
										<div class="field">
											<label class="label is-small">Name</label>
											<input class="input is-small full-width" placeholder="" type="text" name="target-3-name" value="" />
										</div>
										<div class="field">
											<label class="label is-small">Network/mask</label>
											<input class="input is-small full-width" placeholder="" type="text" name="target-3-network" value="" />
										</div>
										<div class="field">
											<label class="label is-small">Maximum Hops</label>
											<input class="input is-small full-width" placeholder="" type="text" name="target-3-hops" value="" />
										</div>
										<div class="field">
											<label class="checkbox">
												<input type="checkbox" name="target-3-extended" value="true" />
												Extended Scan
											</label>
										</div>
									</div>
									<div class="block tabs-block is-hidden" id="config-network-4">
										<div class="field">
											<label class="label is-small">Name</label>
											<input class="input is-small full-width" placeholder="" type="text" name="target-4-name" value="" />
										</div>
										<div class="field">
											<label class="label is-small">Network/mask</label>
											<input class="input is-small full-width" placeholder="" type="text" name="target-4-network" value="" />
										</div>
										<div class="field">
											<label class="label is-small">Maximum Hops</label>
											<input class="input is-small full-width" placeholder="" type="text" name="target-4-hops" value="" />
										</div>
										<div class="field">
											<label class="checkbox">
												<input type="checkbox" name="target-4-extended" value="true" />
												Extended Scan
											</label>
										</div>
									</div>
									<div class="block tabs-block is-hidden" id="config-network-5">
										<div class="field">
											<label class="label is-small">Name</label>
											<input class="input is-small full-width" placeholder="" type="text" name="target-5-name" value="" />
										</div>
										<div class="field">
											<label class="label is-small">Network/mask</label>
											<input class="input is-small full-width" placeholder="" type="text" name="target-5-network" value="" />
										</div>
										<div class="field">
											<label class="label is-small">Maximum Hops</label>
											<input class="input is-small full-width" placeholder="" type="text" name="target-5-hops" value="" />
										</div>
										<div class="field">
											<label class="checkbox">
												<input type="checkbox" name="target-5-extended" value="true" />
												Extended Scan
											</label>
										</div>
									</div>
								</div>
							</div>

							<div class="navbar-item">
								<button class="button is-primary" id="config-save">Save</button>
							</div>
						</fieldset>
					</div>

					<div class="navbar-item has-dropdown has-dropdown is-hoverable">
						<span class="navbar-link">Network</span>
						<div class="navbar-dropdown is-right" id="networks"></div>
					</div>

					<div class="navbar-item has-dropdown has-dropdown is-hoverable">
						<span class="navbar-link">Scan</span>
						<div class="navbar-dropdown is-right" id="scans"></div>
					</div>
				</div>
			</div>
		</nav>
	</section>

	<section>
		<div class="columns">
			<div class="column is-two-thirds">
				<div class="legend">
					<div class="columns is-desktop">
						<div class="column is-narrow"><div class="legend-entry" id="legend-color-normal"></div></div><div class="column legend-text">Normal</div>
						<div class="column is-narrow"><div class="legend-entry" id="legend-color-first"></div></div><div class="column legend-text">First seen</div>
					</div>
					<div class="columns is-desktop">
						<div class="column is-narrow"><div class="legend-entry" id="legend-color-changed"></div></div><div class="column legend-text">Changed</div>
						<div class="column is-narrow"><div class="legend-entry" id="legend-color-removed"></div></div><div class="column legend-text">Removed</div>
					</div>
				</div>
				<div id="networkarea"></div>
			</div>
			<div class="column">
				<div class="scan-info">
					<p><span class="title is-5" id="selected-network"></span> [ <span id="selected-scan"></span> ]</p>
				</div>
				<div class="host-info" id="host-info-box"></div>
				<div class="buttons">
					<a id="btn-pdf" class="button is-info is-light is-fullwidth is-small" download>Download PDF</a>
					<a id="btn-csv" class="button is-info is-light is-fullwidth is-small" download>Download CSV</a>
				</div>
			</div>
		</div>
	</section>

	<footer class="footer p-2">
		<div class="content has-text-centered">
			<p>
				<a href="https://github.com/ITSGmbH/NetworkDiscover">NetworkDiscovery</a>, provided by <a href="https://www.it-s.ch/">IT-S GmbH</a>
				<br/>
				<small>&copy; 2021 by Lukas Zurschmiede</small>
			</p>
		</div>
	</footer>

	<script type="text/javascript">
		var colors = {
			normal: '#d2e5ff',
			first: '#91d782',
			changed: '#f5ce35',
			removed: '#eaafa2'
		};

		// Legend
		document.getElementById("legend-color-normal").style.backgroundColor = colors.normal;
		document.getElementById("legend-color-first").style.backgroundColor = colors.first;
		document.getElementById("legend-color-changed").style.backgroundColor = colors.changed;
		document.getElementById("legend-color-removed").style.backgroundColor = colors.removed;

		function prepareGraph(data, scan) {
			const graph = { nodes: [], edges: [], node_ids: [], root_node: "root" };
			Object.entries(data).forEach(entry => {
				const [k, v] = entry;
				var color = colors.normal;
				if (v.first_scan > 1 && v.first_scan == scan) { color = colors.first; }
				if (v.changed_scan > 1 && v.changed_scan == scan - 1) { color = colors.changed; }
				if (v.is_removed) { color = colors.removed; }

				graph.node_ids.push(v.id);
				graph.nodes.push({
					id: v.id,
					label: v.ip + "\n" + v.os.replace('(', '\n('),
					background: color,
					highlight: color,
					removed: v.is_removed,
					group: v.id % 4
				});
				if (v.nodes.length == 0) { graph.root_node = v.id; }
				v.nodes.forEach(val => {
					graph.edges.push({
						source: v.id,
						target: parseInt(val)
					});
				});
			});
			graph.edges.forEach(val => {
				if (!graph.node_ids.includes(val.target)) {
					val.target = graph.root_node;
				}
			});
			if (graph.root_node == "root") {
				graph.nodes.push({
					id: "root",
					label: "",
					background: "#fd8",
					highlight: "#d81",
					removed: true
				});
			}
			delete graph.node_ids;
			return graph;
		}

		// d3 test
		var width  = document.getElementById("networkarea").offsetWidth,
		    height = document.getElementById("networkarea").offsetHeight,
		    radius = 20,
		    labelsize = 12;

		var load_network = ev => {
			$.getJSON("/api/network?network=" + ev.data.network + '&scan=' + ev.data.scan, data => {

				d3.selectAll("#networkarea > *").remove();
				const svg = d3.select("#networkarea")
					.append('svg')
					.attr("viewBox", [ 0, 0, width, height ])
					.attr("style", "max-width: 100%; height: 100%;");

				// Centric-Force based visualization
				const graph = prepareGraph(data, ev.data.scan);
				const simulation = d3.forceSimulation()
					.force("link", d3.forceLink().id(d => d.id).distance(200))
					.force("cluster", forceCluster())
					.force("charge", d3.forceManyBody().strength(-1000))
					.force("collision", d3.forceCollide().radius(radius * 1.5))
					.force("center", d3.forceCenter(width/2, height/2))
					;

				const links = svg.append("g")
						.attr("class", "links")
						.attr("stroke", "#996666")
						.attr("stroke-width", 1.5)
					.selectAll("line")
						.data(graph.edges)
						.enter()
						.append("line")
						.attr("class", "link");

				const nodes = svg.append("g")
						.attr("class", "nodes")
						.attr("fill", "#fff")
						.attr("stroke", "#000")
						.attr("stroke-width", 1.5)
					.selectAll("circle")
						.data(graph.nodes)
						.enter()
						.append("circle")
						.attr("class", "node")
						.attr("fill", d => d.background)
						.attr("stroke", d => d.highlight)
						.attr("r", radius)
					.call(
						d3.drag()
							.on("start", dragstarted)
							.on("drag", dragged)
							.on("end", dragended)
					);

				const labels = svg.append("g")
						.attr("class", "node-labels")
					.selectAll("text")
						.data(graph.nodes)
						.enter()
						.append("text")
						.attr("class", "node-label")
						.attr("font-size", labelsize + "px")
						.attr("fill", "black");

				const label_lines = labels
					.selectAll("tspan")
					.data(d => d.label.split('\n'))
					.enter()
						.append("tspan")
						.text(d => d)
						.attr("text-anchor", "middle")
						.attr("x", 0)
						.attr("dy", labelsize * 1.2);

				nodes.on("click", (datum, n) => selectNode([ n.id ]) );
				simulation.nodes(graph.nodes).on("tick", updateGraph);
				simulation.force("link").links(graph.edges);

				function centroid(nodes) {
					let x = 0;
					let y = 0;
					let z = 0;
					for (const d of nodes) {
						let k = radius ** 2;
						x += d.x * k;
						y += d.y * k;
						z += k;
					}
					return {x: x / z, y: y / z};
				}

				function forceCluster() {
					let nodes;
					function force(alpha) {
						const centroids = d3.rollup(nodes, centroid, d => d.group);
						const l = alpha * 0.5;
						for (const d of nodes) {
							const { x: cx, y: cy } = centroids.get(d.group);
							d.vx -= (d.x - (cx || 1)) * l;
							d.vy -= (d.y - (cy || 1)) * l;
						}
					}
					force.initialize = n => nodes = n;
					return force;
				}

				function updateGraph() {
					links
						.attr("x1", d => d.source.x)
						.attr("y1", d => d.source.y)
						.attr("x2", d => d.target.x)
						.attr("y2", d => d.target.y);

					nodes
						.attr("cx", d => d.x)
						.attr("cy", d => d.y);
					labels
						.attr("transform", d => "translate(" + (d.x) + "," + (d.y + radius) + ")");
				}

				function dragstarted(ev, d) {
					if (!ev.active) {
						simulation.alphaTarget(0.3).restart();
					}
					d.fx = d.x;
					d.fy = d.y;
				}

				function dragged(ev, d) {
					d.fx = ev.x;
					d.fy = ev.y;
				}

				function dragended(ev, d) {
					if (!ev.active) {
						simulation.alphaTarget(0);
					}
					d.fx = null;
					d.fy = null;
				}

				$('#host-info-box').empty();
				$('#networkarea').data('network', ev.data.network)
				$('#networkarea').data('scan', ev.data.scan)

				$('#btn-pdf').attr('href', '/export/pdf?network=' + ev.data.network + '&scan=' + ev.data.scan);
				$('#btn-csv').attr('href', '/export/csv?network=' + ev.data.network + '&scan=' + ev.data.scan);
			});
		}

		var load_scans = ev => {
			$.getJSON("/api/scans?network=" + ev.data.network, scans => {
				$('#scans').empty();

				$('#scans').append('<div class="navbar-item field"><p class="control has-icons-left"><input id="scans-search" type="text" class="input is-info is-small" placeholder="Search..." /><span class="icon is-small is-left"><i class="fas fa-search"></i></span></p></div>');
				$('#scans-search').on('keyup', ev => {
					let val = $('#scans-search').val().toLowerCase();
					if (val == '') {
						$('#scans a.navbar-item').removeClass("is-hidden");
					} else {
						$('#scans a.navbar-item').each((_, elem) => {
							if (elem.innerText.toLowerCase().indexOf(val) == -1) { $(elem).addClass("is-hidden"); }
							else { $(elem).removeClass("is-hidden"); }
						});
					}
				});

				$('#scans').append('<a class="navbar-item" id="scan-now">Scan now</a>');
				$('#scan-now').on('click', { id: 'now'}, trigger_scan);

				$('#scans').append('<div id="scan-now-modal" class="modal"><div class="modal-background"></div><div class="modal-card"></div></div>')
				var header = $('<header class="modal-card-head"><p class="modal-card-title">Scan triggered</p><button class="delete" aria-label="close"></button></header>');
				var content = $('<section class="modal-card-body">A new scan is triggered and will start shortly.</section>');
				var footer = $('<footer class="modal-card-foot"><button class="button is-info">Close</button></footer>');
				$('#scan-now-modal .modal-card').append(header);
				$('#scan-now-modal .modal-card').append(content);
				$('#scan-now-modal .modal-card').append(footer);
				$('#scan-now-modal button.delete').on('click', _ev => { $('#scan-now-modal').toggleClass('is-active'); });
				$('#scan-now-modal button.is-info').on('click', _ev => { $('#scan-now-modal').toggleClass('is-active'); });

				scans.forEach((v, k) => {
					$('#scans').append('<a class="navbar-item" id="scan-' + k + '">' + v.start + '</a>');
					$('#scan-' + k).on('click', { id: k, network: v.network, scan: v.scan, time: v.start }, click_ev => {
						$('#scans .navbar-item').removeClass('is-active');
						$('#scan-' + click_ev.data.id).addClass('is-active');
						$('#selected-scan').empty();
						$('#selected-scan').append(click_ev.data.time);
						load_network(click_ev);
					});
				});
				$('#scan-' + (scans.length - 1)).trigger('click');
			});
		};

		var trigger_scan = ev => {
			$.getJSON("/api/scan_now", data => {
				$('#scan-now-modal').toggleClass('is-active');
			});
		}

		$(document).ready(function() {
			$.getJSON("/api/networks", data => {
				$('#networks').empty();

				$('#networks').append('<div class="navbar-item field"><p class="control has-icons-left"><input id="networks-search" type="text" class="input is-info is-small" placeholder="Search..." /><span class="icon is-small is-left"><i class="fas fa-search"></i></span></p></div>');
				$('#networks-search').on('keyup', ev => {
					let val = $('#networks-search').val().toLowerCase();
					if (val == '') {
						$('#networks a.navbar-item').removeClass("is-hidden");
					} else {
						$('#networks a.navbar-item').each((_, elem) => {
							if (elem.innerText.toLowerCase().indexOf(val) == -1) { $(elem).addClass("is-hidden"); }
							else { $(elem).removeClass("is-hidden"); }
						});
					}
				});

				data.forEach((v, k) => {
					var name = v.name + ( v.name != "" ? " (" : "" ) + v.network + ( v.name != "" ? ")" : "" );
					$('#networks').append('<a class="navbar-item" id="network-' + k + '">' + name + '</a>');
					$('#network-' + k).on('click', { id: k, network: v.network, name: name }, click_ev => {
						$('#networks .navbar-item').removeClass('is-active');
						$('#network-' + k).addClass('is-active');
						$('#selected-network').empty();
						$('#selected-network').append(click_ev.data.name);
						load_scans(click_ev);
					});
					$('#network-' + k).data('network', v);
				});
				$('#network-0').trigger('click');
			}).fail(function() {
				console.error("Error while loading Networks.");
			});

			$('#config-network .tabs li').each(function(_, elem) {
				elem = $(elem);
				elem.on('click', ev => {
					$('#config-network .tabs li').removeClass('is-active');
					$('#config-network .tabs-block').removeClass('is-hidden').addClass('is-hidden');
					elem.addClass('is-active');
					$('#' + elem.attr('id').replace('-tab', '')).removeClass('is-hidden');
				});
			});

			$.getJSON("/api/config", data => {
				$('#config [name="repeat"]').prop('value', data.repeat);
				$('#config [name="threads"]').prop('value', data.num_threads);
				$('#config [name="interface"]').prop('value', data.device);
				$('#config [name="name"]').prop('value', data.name);
				if (data.listen) {
					$('#config [name="listen-ip"]').prop('value', data.listen.ip);
					$('#config [name="listen-port"]').prop('value', data.listen.port);
				}
				if (data.sqlite) {
					$('#config [name="db-path"]').prop('value', data.sqlite.file);
					$('#config [name="db-url"]').prop('value', data.sqlite.url);
				}
				if (data.targets && data.targets.forEach) {
					data.targets.forEach((v, k) => {
						idx = k + 1;
						$('#config [name="target-' + idx + '-name"]').prop('value', v.target.name);
						$('#config [name="target-' + idx + '-network"]').prop('value', v.target.ip + '/' + v.target.mask);
						$('#config [name="target-' + idx + '-hops"]').prop('value', v.max_hops);
						$('#config [name="target-' + idx + '-extended"]').prop('checked', v.extended);
					});
				}

				$('#config-save').on('click', function() {
					$('#config-save').attr('disabled', 'disabled');
					config = {
						name: $('#config [name="name"]').prop('value').trim() ? $('#config [name="name"]').prop('value').trim() : null,
						repeat: $('#config [name="repeat"]').prop('value').trim() ? parseInt($('#config [name="repeat"]').prop('value')) : null,
						num_threads: $('#config [name="threads"]').prop('value').trim() ? parseInt($('#config [name="threads"]').prop('value')) : null,
						device: $('#config [name="interface"]').prop('value').trim() ? $('#config [name="interface"]').prop('value').trim() : null,
						listen: $('#config [name="listen-ip"]').prop('value').trim() ? {
						 ip: $('#config [name="listen-ip"]').prop('value').trim(),
						 port: parseInt($('#config [name="listen-port"]').prop('value')),
						} : null,
						sqlite: $('#config [name="db-path"]').prop('value').trim() || $('#config [name="db-url"]').prop('value').trim() ? {
						 file: $('#config [name="db-path"]').prop('value').trim() ? $('#config [name="db-path"]').prop('value').trim() : null,
						 url: $('#config [name="db-url"]').prop('value').trim() ? $('#config [name="db-url"]').prop('value').trim() : null,
						} : null,
						targets: [],
					};
					[1,2,3,4,5].forEach(idx => {
						var id = "target-" + idx;
						if ($('#config [name="' + id + '-name"]').prop('value').trim()) {
							var nw = $('#config [name="' + id + '-network"]').prop('value').trim().split("/");
							config.targets[idx-1] = {
								extended: $('#config [name="' + id + '-extended"]').prop('checked'),
								max_hops: parseInt($('#config [name="' + id + '-hops"]').prop('value')),
								target: {
									name: $('#config [name="' + id + '-name"]').prop('value').trim(),
									ip: nw[0].trim(),
									mask: parseInt(nw[1]),
								}
							};
						}
					});

					$.ajax("/api/config", {
						type: 'POST',
						contentType: 'application/json',
						data: JSON.stringify(config),
						success: function(resp) {
							setTimeout(function() {$('#config-save').removeAttr('disabled');}, 1500);
						},
					});
				});
			}).fail(function() {
				console.error("Error while fetching configuration.");
			});

			window.setInterval(function() {
				$.getJSON("/api/status", data => {
					message = '...';
					if (data.running) {
						message = "running";
					} else if (data.paused) {
						message = "paused";
					} else if (data.triggered) {
						message = "triggered...";
					}
					$('#running-status').addClass('is-warning');
					$('#running-status').removeClass('is-danger');
					$('#running-status').html(message);
				})
				.fail(err => {
					$('#running-status').addClass('is-danger');
					$('#running-status').removeClass('is-warning');
					$('#running-status').html('check failed...');
				});
			}, 5000);
		});

		function fill_host_info_box(cont, data, with_hist) {
			if (with_hist) {
				$('.message-body', cont).append('<div class="dropdown is-hoverable"><div class="dropdown-trigger"><div class="mouse-pointer" aria-haspopup="true" aria-controls="dropdown-menu"><strong>Scan from:</strong> ' + (new Date(data.scan_timestamp)).toUTCString() + '</div></div><div class="dropdown-menu" id="dropdown-menu" role="menu"><div class="dropdown-content" id="host-scan-host-list"></div></div></div>');
				$('.message-body', cont).append('<div id="modal-hosts-history"></div>');
			} else {
				$('.message-body', cont).append('<div><strong>Scan from:</strong> ' + (new Date(data.scan_timestamp)).toUTCString() + '</div>');
			}
			$('.message-body', cont).append('<div style="padding-top:0.2rem;"><strong>OS:</strong> ' + data.os + '</div>');
			$('.message-body', cont).append('<hr size="1" />');

			var table = $('.message-body', cont).append('<div class="mt-4 table-container"><table class="table is-striped is-fullwidth"><tbody class="mainbody"></tbody></table></div>');
			data.ports.forEach(port => {
				var id = 'cve_' + data.ip.replace(/\./gi, '_') + '-' + port.port + '_' + port.protocol;
				$('tbody.mainbody', table).append('<tr><td>' + port.port + '/' + port.protocol + '<br/>' + port.service + '</td><td>' + port.product + '</td><td id="' + id + '"></td></tr>');

				if (port.cves.length > 0) {
					$('#' + id, table).append('<button class="button is-small is-danger is-light">CVEs</button>');
					var header = $('<header class="modal-card-head"><p class="modal-card-title">CVEs of ' + data.ip + ', Port ' + port.port + '/' + port.protocol + '</p><button class="delete" aria-label="close"></button></header>');
					var cves = $('<section class="modal-card-body"><table class="table is-fullwidth"><tbody class="cvebody"></tbody></table></section>');

					port.cves.sort((a, b) => a.cvss < b.cvss);
					port.cves.sort((a, b) => a.database < b.database);
					var last_db = '';
					port.cves.forEach(cve => {
						if (cve.database.length == 0 && cve.id.length == 0)
							return;
						var link = 'https://vulners.com/' + cve.database + '/' + cve.id;
						if (last_db != cve.database) {
							$('tbody.cvebody', cves).append('<tr><th colspan="3">' + cve.database + '</th></tr>');
						}
						$('tbody.cvebody', cves).append('<tr><td><a target="_blank" href="' + link + '">' + cve.id + '</a></td><td>' + (cve.exploit ? '<span class="tag is-danger">Exploit</span>' : '') + '</td><td>' + cve.cvss + '</td></tr>');
						last_db = cve.database;
					});

					$('#' + id, table).append('<div id="' + id + '-modal" class="modal"><div class="modal-background"></div><div class="modal-card"></div></div>')
					$('#' + id + ' .modal-card', table).append(header);
					$('#' + id + ' .modal-card', table).append(cves);

					$('#' + id + ' button.button', table).on('click', { id: id }, _ev => { $('#' + _ev.data.id + '-modal').toggleClass('is-active'); });
					$('#' + id + ' button.delete', table).on('click', { id: id }, _ev => { $('#' + _ev.data.id + '-modal').toggleClass('is-active'); });
				}
			});
		}

		function selectNode(nodes) {
			$.getJSON("/api/info?network=" + $('#networkarea').data('network') + "&scan=" + $('#networkarea').data('scan') + "&info=" + nodes.join(';'), data => {
				$('#host-info-box').empty();

				var cont = $('<article class="message"><div class="message-header"><p>' + data.ip + '</p></div><div class="message-body"></div></article>');
				fill_host_info_box(cont, data, true);

				// Modal: Hosts History
				$('#modal-hosts-history', cont).append('<div class="modal"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">History of: ?</p><button class="delete" aria-label="close"></button></header><section class="modal-card-body"><div class="columns"><div class="column col-left"><div class="message-body">left</div></div><div class="column col-right"><div class="message-body">right</div></div></div></section><footer class="modal-card-foot"><button class="button">Close</button></footer></div></div>');
				data.scan_history.forEach(hist => {
					$('#host-scan-host-list', cont).append('<div class="dropdown-item mouse-pointer" data-scan="' + hist.scan + '"><strong>' + hist.scan + ':</strong> ' + (new Date(hist.start)).toUTCString() + '</div>');
				});
				$('#modal-hosts-history .modal button', cont).on('click', _ev => {
					$('#modal-hosts-history .modal', cont).toggleClass('is-active');
				});

				// Fill Hosts-History
				$('#host-scan-host-list .dropdown-item', cont).on('click', _ev => {
					$.getJSON("/api/info?network=" + $('#networkarea').data('network') + "&scan=" + $(_ev.target).data('scan') + "&info=" + nodes.join(';'), hist_data => {
						$('#modal-hosts-history .modal-card .message-body', cont).empty();
						$('#modal-hosts-history .modal-card-title', cont).empty();
						$('#modal-hosts-history .modal-card-title', cont).append('History of: ' + hist_data.ip);
						fill_host_info_box($('#modal-hosts-history .modal-card .col-left', cont), hist_data, false);
						fill_host_info_box($('#modal-hosts-history .modal-card .col-right', cont), data, false);
						$('#modal-hosts-history .modal', cont).toggleClass('is-active');
					});
				});

				$('#host-info-box').append(cont);
			});
		}


	</script>
</body>
</html>
