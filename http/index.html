<!DOCTYPE html>
<html>
<head>
	<title>Network</title>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta charset="utf-8">
	<script type="text/javascript" src="/js/jquery.min.js"></script>
	<script type="text/javascript" src="/js/vis_network.min.js"></script>
	<link rel="stylesheet" href="/css/bulma.min.css">
	<link rel="icon" type="image/png" href="/img/its_logo.png">
	<style type="text/css">
		#networkarea {
			width: 100%;
			height: 85vh;
			border: 1px solid lightgray;
		}
	</style>
	</style>
</head>
<body>
	<section class="section pb-3">
		<nav class="navbar is-info is-fixed-top" role="navigation" aria-label="dropdown navigation">
			<div class="navbar-menu">
				<div class="navbar-start">
					<div class="navbar-brand">
						<span class="navbar-item"><img src="/img/its_logo.png" alt="IT-S" height="12" /></span>
						<h1 class="navbar-item title is-4">NetworkDiscovery</h1>
					</div>
				</div>

				<div class="navbar-end">
					<div class="navbar-item has-dropdown has-dropdown is-hoverable">
						<span class="navbar-link">Network</span>
						<div class="navbar-dropdown" id="networks"></div>
					</div>
					<div class="navbar-item has-dropdown has-dropdown is-hoverable">
						<span class="navbar-link">Scan</span>
						<div class="navbar-dropdown is-right" id="scans"></div>
					</div>
				</div>
			</div>
		</nav>
	</section>

	<section class="">
		<div class="columns">
			<div class="column is-two-thirds">
				<div id="networkarea"></div>
			</div>
			<div class="column">
				<div class="buttons">
					<a id="btn-pdf" class="button is-info is-light is-fullwidth is-small" download>Download PDF</a>
					<a id="btn-csv" class="button is-info is-light is-fullwidth is-small" download>Download CSV</a>
				</div>
				<div class="" id="networkinfo"></div>
			</div>
		</div>
	</section>

	<footer class="footer p-2">
		<div class="content has-text-centered">
			<p>
				<a href="https://github.com/ITSGmbH/NetworkDiscover">NetworkDiscovery</a>, provided by <a href="https://www.it-s.ch/">IT-S GmbH</a>
				<br/>
				<small>&copy; 2021 by Lukas Zurschmiede</small>
			</p>
		</div>
	</footer>

	<script type="text/javascript">
		// VIS-Network documentation: https://visjs.github.io/vis-network/docs/network/
		var nodes = new vis.DataSet();
		var edges = new vis.DataSet();
		var container = document.getElementById("networkarea");
		var data = {
			nodes: nodes,
			edges: edges,
		};
		var options = {
			layout: {
				hierarchical: {
					direction: "UD",
					sortMethod: "hubsize",
				},
			},
			interaction: { dragNodes: false },
			physics: {
				enabled: true,
				hierarchicalRepulsion: { avoidOverlap: 0.7 }
			},
		};
		var network = new vis.Network(container, data, options);

		var load_network = ev => {
			$.getJSON("/api/network?network=" + ev.data.network + '&scan=' + ev.data.scan, data => {
				var _nodes = [];
				var _edges = [];
				Object.entries(data.hosts).forEach(entry => {
					const [k, v] = entry;
					_nodes.push({ id: k, label: k + '\n' + v.os });
					v.nodes.forEach(val => {
						_edges.push({ from: k, to: val });
					})
				});
				nodes.clear();
				edges.clear()
				nodes.add(_nodes);
				edges.add(_edges);
				$('#networkinfo').empty();
				$('#networkarea').data('network', ev.data.network)
				$('#networkarea').data('scan', ev.data.scan)

				$('#btn-pdf').attr('href', '/export/' + ev.data.network + '?type=pdf&scan=' + ev.data.scan);
				$('#btn-csv').attr('href', '/export/' + ev.data.network + '?type=csv&scan=' + ev.data.scan);
			});
		}

		var load_scans = ev => {
			$.getJSON("/api/scans?network=" + ev.data.network, scans => {
				$('#scans').empty();
				scans.scans.forEach((v, k) => {
					$('#scans').append('<a class="navbar-item" id="scan-' + k + '">' + v.start + '</a>');
					$('#scan-' + k).on('click', { id: k, network: ev.data.network, scan: v.scan }, load_network);
				});
				$('#scan-' + (scans.scans.length - 1)).trigger('click');
			});
		};

		$(document).ready(function() {
			$.getJSON("/api/networks", data => {
				data.networks.forEach((v, k) => {
					$('#networks').append('<a class="navbar-item" id="network-' + k + '">' + v + '</a>');
					$('#network-' + k).on('click', { id: k, network: v }, load_scans);
				});
				$('#network-0').trigger('click');
			}).fail(function() {
				console.error("An error has occurred.");
			});
		});

		network.on('selectNode', ev => {
			$.getJSON("/api/info?network=" + $('#networkarea').data('network') + "&scan=" + $('#networkarea').data('scan') + "&info=" + ev.nodes.join(';'), data => {
				$('#networkinfo').empty();

				Object.values(data.info).forEach(entry => {
					var cont = $('<article class="message"><div class="message-header"><p>' + entry.ip + '</p></div><div class="message-body"></div></article>')
					$('div.message-body', cont).append('<p><strong>Scan time:</strong> ' + (new Date(entry.scan_timestamp)).toUTCString() + '</p>');
					$('div.message-body', cont).append('<p><strong>OS:</strong> ' + entry.os + '</p>');
					var table = $('div.message-body', cont).append('<div class="mt-4 table-container"><table class="table is-striped is-fullwidth"><tbody class="mainbody"></tbody></table></div>');

					entry.ports.forEach(port => {
						var id = 'cve_' + entry.ip.replace(/\./gi, '_') + '-' + port.port + '_' + port.protocol;
						$('tbody.mainbody', table).append('<tr><td>' + port.port + '/' + port.protocol + '<br/>' + port.service + '</td><td>' + port.product + '</td><td id="' + id + '"></td></tr>')

						if (port.cves.length > 0) {
							$('#' + id, table).append('<button class="button is-small is-danger is-light">CVEs</button>');
							var header = $('<header class="modal-card-head"><p class="modal-card-title">CVEs of ' + entry.ip + ', Port ' + port.port + '/' + port.protocol + '</p><button class="delete" aria-label="close"></button></header>');
							var cves = $('<section class="modal-card-body"><table class="table is-fullwidth"><tbody class="cvebody"></tbody></table></section>');

							port.cves.sort((a, b) => a.cvss < b.cvss);
							port.cves.sort((a, b) => a.database < b.database);
							var last_db = '';
							port.cves.forEach(cve => {
								if (cve.database.length == 0 && cve.id.length == 0)
									return;
								var link = 'https://vulners.com/' + cve.database + '/' + cve.id;
								if (last_db != cve.database) {
									$('tbody.cvebody', cves).append('<tr><th colspan="3">' + cve.database + '</th></tr>');
								}
								$('tbody.cvebody', cves).append('<tr><td><a target="_blank" href="' + link + '">' + cve.id + '</a></td><td>' + (cve.exploit ? '<span class="tag is-danger">Exploit</span>' : '') + '</td><td>' + cve.cvss + '</td></tr>');
								last_db = cve.database;
							});

							$('#' + id, table).append('<div id="' + id + '-modal" class="modal"><div class="modal-background"></div><div class="modal-card"></div></div>')
							$('#' + id + ' .modal-card', table).append(header);
							$('#' + id + ' .modal-card', table).append(cves);

							$('#' + id + ' button.button', table).on('click', { id: id }, _ev => { $('#' + _ev.data.id + '-modal').toggleClass('is-active'); });
							$('#' + id + ' button.delete', table).on('click', { id: id }, _ev => { $('#' + _ev.data.id + '-modal').toggleClass('is-active'); });
						}
					});

					$('#networkinfo').append(cont);
				});
			});
		});
	</script>
</body>
</html>
